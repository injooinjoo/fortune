name: Flutter Test CI

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'
      - '.github/workflows/flutter-test.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'
      - '.github/workflows/flutter-test.yml'
  workflow_dispatch:

jobs:
  test:
    name: Test Flutter App
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.0'
        channel: 'stable'
    
    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          .dart_tool
          build
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-
    
    - name: Setup test environment
      run: |
        # Create .env from .env.test for CI
        cp .env.test .env
        # Create missing asset directories
        mkdir -p assets/images/character/lunch
        mkdir -p assets/decorations
        mkdir -p assets/icons/traditional
        mkdir -p assets/animations
        # Add placeholder files
        touch assets/images/character/lunch/.gitkeep
        touch assets/decorations/.gitkeep
        touch assets/icons/traditional/.gitkeep
        touch assets/animations/.gitkeep

    - name: Get dependencies
      run: flutter pub get

    - name: Analyze code
      run: flutter analyze --no-fatal-infos --no-fatal-warnings
      continue-on-error: true
    
    - name: Check code formatting
      run: dart format --set-exit-if-changed .
    
    - name: Run tests with coverage
      run: |
        # Run tests with machine reporter (NDJSON format)
        flutter test --coverage --machine > test-results.json 2>&1 || true

    - name: Generate test report
      if: always()
      run: |
        # Convert Flutter test results (NDJSON) to JUnit format
        cat > convert_results.py << 'EOFPY'
        import json
        import xml.etree.ElementTree as ET

        testsuite = ET.Element('testsuite')
        testsuite.set('name', 'FlutterTests')
        test_count = 0
        failure_count = 0
        tests_map = {}

        try:
            with open('test-results.json', 'r') as f:
                for line in f:
                    line = line.strip()
                    if not line:
                        continue
                    try:
                        event = json.loads(line)
                        if not isinstance(event, dict):
                            continue
                        event_type = event.get('type', '')
                        if event_type == 'testStart':
                            test_id = event.get('test', {}).get('id')
                            test_name = event.get('test', {}).get('name', 'Unknown')
                            tests_map[test_id] = {'name': test_name}
                        elif event_type == 'testDone':
                            test_id = event.get('testID')
                            result = event.get('result', '')
                            hidden = event.get('hidden', False)
                            if not hidden and test_id in tests_map:
                                test_info = tests_map[test_id]
                                testcase = ET.SubElement(testsuite, 'testcase')
                                testcase.set('name', test_info['name'])
                                testcase.set('classname', 'FlutterTest')
                                testcase.set('time', str(event.get('time', 0) / 1000))
                                test_count += 1
                                if result != 'success':
                                    failure = ET.SubElement(testcase, 'failure')
                                    failure.set('message', 'Test failed')
                                    failure_count += 1
                    except json.JSONDecodeError:
                        continue
        except FileNotFoundError:
            print('test-results.json not found, creating empty report')

        testsuite.set('tests', str(test_count))
        testsuite.set('failures', str(failure_count))
        testsuite.set('errors', '0')
        tree = ET.ElementTree(testsuite)
        tree.write('test-results.xml', encoding='unicode')
        print(f'Generated test-results.xml with {test_count} tests, {failure_count} failures')
        EOFPY
        python3 convert_results.py
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test-results.json
          test-results.xml
    
    - name: Publish test results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2
      with:
        files: test-results.xml
        check_name: Flutter Test Results
        comment_title: Flutter Test Results
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/lcov.info
        flags: flutter
        name: flutter-coverage
        fail_ci_if_error: false
    
    - name: Generate coverage report
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov

        # 생성된 파일 제외 (freezed, g.dart, gen.dart)
        # --ignore-errors unused: 매칭되지 않는 패턴 무시
        lcov --remove coverage/lcov.info \
          '*.freezed.dart' \
          '*.g.dart' \
          '*.gen.dart' \
          '*/generated/*' \
          --ignore-errors unused \
          -o coverage/lcov.info

        # Generate HTML coverage report
        genhtml coverage/lcov.info -o coverage/html

        # Generate coverage summary
        lcov --summary coverage/lcov.info > coverage-summary.txt

        # Extract coverage percentage
        COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep -E "lines\.+:" | sed -E 's/.*lines\.+:\ +([0-9.]+)%.*/\1/')
        echo "Test coverage: $COVERAGE%"
        echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
        
        # Create coverage badge
        if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
          COLOR="brightgreen"
        elif (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          COLOR="green"
        elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
          COLOR="yellow"
        elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
          COLOR="orange"
        else
          COLOR="red"
        fi
        
        echo "COVERAGE_COLOR=$COLOR" >> $GITHUB_ENV
        
        # Check if coverage meets threshold
        if (( $(echo "$COVERAGE < 85" | bc -l) )); then
          echo "::warning::Coverage $COVERAGE% is below 85% threshold"
          # Don't fail the build, just warn
        fi
    
    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage/html/
          coverage-summary.txt
    
    # 커버리지 뱃지는 Codecov에서 제공 (위 단계에서 이미 업로드됨)
    # Gist 기반 뱃지는 제거 - GIST_SECRET 설정 불필요

    - name: Comment PR with results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v6
      with:
        script: |
          const coverage = process.env.COVERAGE || 'N/A';
          const comment = `## Flutter Test Results
          
          **Coverage**: ${coverage}%
          
          View detailed reports in the [Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  integration-test:
    name: Integration Tests
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.0'
        channel: 'stable'

    - name: Setup build environment
      run: |
        cp .env.test .env
        mkdir -p assets/images/character/lunch assets/decorations assets/icons/traditional assets/animations
        touch assets/images/character/lunch/.gitkeep assets/decorations/.gitkeep assets/icons/traditional/.gitkeep assets/animations/.gitkeep

    - name: Get dependencies
      run: flutter pub get

    - name: Run integration tests
      timeout-minutes: 10
      run: |
        # List available simulators
        echo "Available simulators:"
        xcrun simctl list devices available

        # Find and boot an available iPhone simulator
        # Try iPhone 16, then iPhone 15, then any available iPhone
        DEVICE_NAME=""
        for name in "iPhone 16" "iPhone 15" "iPhone 15 Pro" "iPhone 14"; do
          if xcrun simctl list devices available | grep -q "$name"; then
            DEVICE_NAME="$name"
            break
          fi
        done

        if [ -z "$DEVICE_NAME" ]; then
          echo "No compatible iPhone simulator found, using first available"
          DEVICE_NAME=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed 's/.*\(iPhone[^(]*\).*/\1/' | xargs)
        fi

        echo "Using simulator: $DEVICE_NAME"
        xcrun simctl boot "$DEVICE_NAME" 2>/dev/null || true

        # Wait for simulator to be ready
        sleep 5

        # Run integration tests with timeout
        flutter test integration_test/app_test.dart --timeout 120s || echo "Integration tests completed with status: $?"

    - name: Upload integration test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-logs
        path: |
          flutter_test_logs.txt
        if-no-files-found: ignore

  build:
    name: Build Flutter App
    runs-on: ubuntu-latest
    needs: test
    
    strategy:
      matrix:
        platform: [web, android]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.0'
        channel: 'stable'
    
    - name: Setup Java (for Android build)
      if: matrix.platform == 'android'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup build environment
      run: |
        cp .env.test .env
        mkdir -p assets/images/character/lunch assets/decorations assets/icons/traditional assets/animations
        touch assets/images/character/lunch/.gitkeep assets/decorations/.gitkeep assets/icons/traditional/.gitkeep assets/animations/.gitkeep

    - name: Setup Google Services (Android)
      if: matrix.platform == 'android'
      env:
        GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
      run: |
        if [ -n "$GOOGLE_SERVICES_JSON" ]; then
          echo "Using google-services.json from secret"
          echo "$GOOGLE_SERVICES_JSON" | base64 -d > android/app/google-services.json
        else
          echo "Creating placeholder google-services.json for CI build"
          cat > android/app/google-services.json << 'EOFGS'
        {
          "project_info": {
            "project_number": "000000000000",
            "project_id": "placeholder-project",
            "storage_bucket": "placeholder-project.appspot.com"
          },
          "client": [
            {
              "client_info": {
                "mobilesdk_app_id": "1:000000000000:android:0000000000000000",
                "android_client_info": {
                  "package_name": "com.beyond.fortune"
                }
              },
              "oauth_client": [],
              "api_key": [
                {
                  "current_key": "placeholder_api_key"
                }
              ],
              "services": {}
            }
          ],
          "configuration_version": "1"
        }
        EOFGS
        fi

    - name: Get dependencies
      run: flutter pub get

    - name: Build Web
      if: matrix.platform == 'web'
      run: flutter build web --release

    - name: Build Android APK
      if: matrix.platform == 'android'
      run: flutter build apk --release
    
    - name: Build Android App Bundle
      if: matrix.platform == 'android'
      run: flutter build appbundle --release
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.platform }}-build
        path: |
          build/web/
          build/app/outputs/flutter-apk/
          build/app/outputs/bundle/

  deploy-preview:
    name: Deploy Preview (Web)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Download web build
      uses: actions/download-artifact@v4
      with:
        name: web-build
        path: build-output
    
    - name: Deploy to Netlify
      uses: nwtgck/actions-netlify@v2.0
      with:
        publish-dir: './build-output/web'
        production-deploy: false
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "Deploy from GitHub Actions"
        enable-pull-request-comment: true
        enable-commit-comment: false
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      timeout-minutes: 5

  # Slack 알림 (핵심 job 실패 시 단일 알림)
  notify-slack:
    name: Slack Notification
    needs: [test, build]
    if: always() && (needs.test.result == 'failure' || needs.build.result == 'failure')
    uses: ./.github/workflows/slack-notify.yml
    with:
      workflow_name: "Flutter Test CI"
      job_status: "failure"
      failed_jobs: "${{ needs.test.result == 'failure' && 'test ' || '' }}${{ needs.build.result == 'failure' && 'build' || '' }}"
      pr_number: "${{ github.event.pull_request.number || '' }}"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
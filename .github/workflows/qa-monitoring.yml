name: QA Monitoring Pipeline

on:
  # ì •ê¸° ì‹¤í–‰ ìŠ¤ì¼€ì¤„ (ë§¤ì¼ 3íšŒ)
  schedule:
    - cron: '0 0 * * *'   # ì˜¤ì „ 9ì‹œ KST (UTC 0:00)
    - cron: '0 6 * * *'   # ì˜¤í›„ 3ì‹œ KST (UTC 6:00)
    - cron: '0 12 * * *'  # ì˜¤í›„ 9ì‹œ KST (UTC 12:00)

  # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
  workflow_dispatch:
    inputs:
      run_performance:
        description: 'Run performance tests'
        required: false
        default: true
        type: boolean
      run_edge_functions:
        description: 'Run Edge Function health check'
        required: false
        default: true
        type: boolean

env:
  FLUTTER_VERSION: '3.38.0'
  NODE_VERSION: '20.x'

jobs:
  # =====================================================
  # Job 1: ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
  # =====================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      passed: ${{ steps.results.outputs.passed }}
      failed: ${{ steps.results.outputs.failed }}
      total: ${{ steps.results.outputs.total }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: |
          npm ci
          npx playwright install --with-deps chromium
          # Setup test environment
          cp .env.test .env
          mkdir -p assets/images/character/lunch assets/decorations assets/icons/traditional assets/animations
          touch assets/images/character/lunch/.gitkeep assets/decorations/.gitkeep assets/icons/traditional/.gitkeep assets/animations/.gitkeep
          flutter pub get

      - name: Build Flutter Web
        run: flutter build web --release

      - name: Run Smoke Tests
        id: test
        run: |
          # Playwright webServer ì„¤ì •ì´ ìë™ìœ¼ë¡œ ì„œë²„ë¥¼ ì‹œì‘í•¨
          npx playwright test smoke.spec.js \
            --project=chromium \
            --reporter=json \
            --output=test-results.json || true
        env:
          CI: true

      - name: Parse test results
        id: results
        run: |
          if [ -f "test-results.json" ]; then
            PASSED=$(jq '.stats.expected // 0' test-results.json)
            FAILED=$(jq '.stats.unexpected // 0' test-results.json)
            TOTAL=$((PASSED + FAILED))
          else
            PASSED=0
            FAILED=1
            TOTAL=1
          fi

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-results-${{ github.run_id }}
          path: |
            test-results/
            test-results.json
          retention-days: 30

  # =====================================================
  # Job 2: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (Lighthouse)
  # =====================================================
  performance-tests:
    name: Performance Tests (Lighthouse)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: ${{ github.event.inputs.run_performance != 'false' }}
    outputs:
      performance_score: ${{ steps.lighthouse.outputs.performance }}
      lcp: ${{ steps.lighthouse.outputs.lcp }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Build Flutter Web
        run: |
          # Setup test environment
          cp .env.test .env
          mkdir -p assets/images/character/lunch assets/decorations assets/icons/traditional assets/animations
          touch assets/images/character/lunch/.gitkeep assets/decorations/.gitkeep assets/icons/traditional/.gitkeep assets/animations/.gitkeep
          flutter pub get
          flutter build web --release

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install serve
        run: npm install -g serve

      - name: Run Lighthouse
        id: lighthouse
        run: |
          # ì„œë²„ ì‹œì‘
          serve build/web -l 3000 &
          sleep 5

          # Lighthouse ì‹¤í–‰
          npm install -g lighthouse

          lighthouse http://localhost:3000 \
            --output=json \
            --output-path=./lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox" \
            --only-categories=performance,accessibility,best-practices \
            --preset=mobile || true

          # ê²°ê³¼ íŒŒì‹±
          if [ -f "lighthouse-report.json" ]; then
            PERF=$(jq '.categories.performance.score * 100 | floor' lighthouse-report.json)
            LCP=$(jq '.audits["largest-contentful-paint"].numericValue | floor' lighthouse-report.json)
            echo "performance=$PERF" >> $GITHUB_OUTPUT
            echo "lcp=$LCP" >> $GITHUB_OUTPUT
          else
            echo "performance=0" >> $GITHUB_OUTPUT
            echo "lcp=0" >> $GITHUB_OUTPUT
          fi

          pkill -f "serve build/web" || true

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report-${{ github.run_id }}
          path: lighthouse-report.json
          retention-days: 30

  # =====================================================
  # Job 3: Edge Function í—¬ìŠ¤ì²´í¬
  # =====================================================
  edge-function-health:
    name: Edge Function Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ github.event.inputs.run_edge_functions != 'false' }}
    outputs:
      healthy: ${{ steps.health.outputs.healthy }}
      total: ${{ steps.health.outputs.total }}
      failed_functions: ${{ steps.health.outputs.failed_functions }}

    steps:
      - name: Health check Edge Functions
        id: health
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          FUNCTIONS=(
            "fortune-daily"
            "fortune-love"
            "fortune-compatibility"
            "fortune-blind-date"
            "fortune-career"
            "fortune-mbti"
            "fortune-dream"
            "fortune-biorhythm"
            "fortune-investment"
            "fortune-moving"
            "calculate-saju"
          )

          HEALTHY=0
          FAILED_LIST=""
          TOTAL=${#FUNCTIONS[@]}

          # Supabase URLì´ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° ê±´ë„ˆë›°ê¸°
          if [ -z "$SUPABASE_URL" ]; then
            echo "::warning::SUPABASE_URL secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Edge Function í—¬ìŠ¤ì²´í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo "healthy=0" >> $GITHUB_OUTPUT
            echo "total=${#FUNCTIONS[@]}" >> $GITHUB_OUTPUT
            echo "failed_functions=SKIPPED_NO_URL" >> $GITHUB_OUTPUT
            exit 0
          fi

          for func in "${FUNCTIONS[@]}"; do
            echo "Checking $func..."

            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST "$SUPABASE_URL/functions/v1/$func" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${SUPABASE_ANON_KEY:-anonymous}" \
              -d '{"healthCheck": true}' \
              --max-time 30 || echo "000")

            if [ "$STATUS" = "200" ] || [ "$STATUS" = "400" ] || [ "$STATUS" = "401" ]; then
              echo "âœ… $func: $STATUS"
              ((HEALTHY++))
            else
              echo "âŒ $func: $STATUS"
              FAILED_LIST="$FAILED_LIST $func"
            fi
          done

          echo "healthy=$HEALTHY" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "failed_functions=$FAILED_LIST" >> $GITHUB_OUTPUT

  # =====================================================
  # Job 4: ê²°ê³¼ ì§‘ê³„ ë° ì•Œë¦¼
  # =====================================================
  aggregate-and-notify:
    name: Aggregate Results & Notify
    runs-on: ubuntu-latest
    needs: [smoke-tests, performance-tests, edge-function-health]
    if: always()

    steps:
      - name: Calculate overall status
        id: status
        run: |
          SMOKE_FAILED="${{ needs.smoke-tests.outputs.failed }}"
          PERF_SCORE="${{ needs.performance-tests.outputs.performance_score }}"
          EDGE_HEALTHY="${{ needs.edge-function-health.outputs.healthy }}"
          EDGE_TOTAL="${{ needs.edge-function-health.outputs.total }}"

          # ì‹¤íŒ¨ ì¡°ê±´ ì²´í¬
          FAILED=false

          if [ "$SMOKE_FAILED" != "0" ] && [ -n "$SMOKE_FAILED" ]; then
            FAILED=true
            echo "âŒ Smoke tests failed: $SMOKE_FAILED failures"
          fi

          if [ -n "$PERF_SCORE" ] && [ "$PERF_SCORE" -lt 50 ] 2>/dev/null; then
            FAILED=true
            echo "âŒ Performance score too low: $PERF_SCORE"
          fi

          if [ -n "$EDGE_HEALTHY" ] && [ -n "$EDGE_TOTAL" ]; then
            if [ "$EDGE_HEALTHY" -lt "$EDGE_TOTAL" ]; then
              echo "âš ï¸ Some Edge Functions unhealthy: $EDGE_HEALTHY/$EDGE_TOTAL"
            fi
          fi

          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      - name: Generate summary
        run: |
          echo "## ğŸ“Š QA Monitoring Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì‹¤í–‰ ì‹œê°„:** $(date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê²°ê³¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¥ Smoke Tests | ${{ needs.smoke-tests.outputs.passed }}/${{ needs.smoke-tests.outputs.total }} passed |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Performance | ${{ needs.performance-tests.outputs.performance_score }}/100 |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”Œ Edge Functions | ${{ needs.edge-function-health.outputs.healthy }}/${{ needs.edge-function-health.outputs.total }} healthy |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.status.outputs.failed }}" = "true" ]; then
            echo "### âŒ ì‹¤íŒ¨ ê°ì§€" >> $GITHUB_STEP_SUMMARY
            echo "ìë™ìœ¼ë¡œ GitHub Issueê°€ ìƒì„±ë©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼" >> $GITHUB_STEP_SUMMARY
          fi

  # =====================================================
  # Job 5: ì‹¤íŒ¨ ì‹œ GitHub Issue ìƒì„±
  # =====================================================
  create-issue-on-failure:
    name: Create Issue on Failure
    runs-on: ubuntu-latest
    needs: [smoke-tests, performance-tests, edge-function-health, aggregate-and-notify]
    if: |
      always() &&
      (needs.smoke-tests.outputs.failed != '0' ||
       needs.performance-tests.outputs.performance_score < 50 ||
       needs.edge-function-health.outputs.healthy != needs.edge-function-health.outputs.total)

    steps:
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const date = new Date().toISOString().split('T')[0];

            const smokeResults = {
              passed: '${{ needs.smoke-tests.outputs.passed }}',
              failed: '${{ needs.smoke-tests.outputs.failed }}',
              total: '${{ needs.smoke-tests.outputs.total }}'
            };

            const perfScore = '${{ needs.performance-tests.outputs.performance_score }}';
            const edgeHealthy = '${{ needs.edge-function-health.outputs.healthy }}';
            const edgeTotal = '${{ needs.edge-function-health.outputs.total }}';
            const failedFunctions = '${{ needs.edge-function-health.outputs.failed_functions }}';

            const smokeStatus = smokeResults.failed === '0' ? 'âœ…' : 'âŒ';
            const perfStatus = parseInt(perfScore) >= 50 ? 'âœ…' : 'âŒ';
            const edgeStatus = edgeHealthy === edgeTotal ? 'âœ…' : 'âš ï¸';

            let bodyLines = [
              '## ğŸš¨ QA ëª¨ë‹ˆí„°ë§ ì‹¤íŒ¨ ë³´ê³ ì„œ',
              '',
              `**ì¼ì‹œ:** ${date}`,
              `**ì‹¤í–‰ ID:** \`${context.runId}\``,
              '',
              '### í…ŒìŠ¤íŠ¸ ê²°ê³¼',
              '',
              '| í•­ëª© | ê²°ê³¼ | ìƒíƒœ |',
              '|------|------|------|',
              `| Smoke Tests | ${smokeResults.passed}/${smokeResults.total} passed | ${smokeStatus} |`,
              `| Performance | ${perfScore}/100 | ${perfStatus} |`,
              `| Edge Functions | ${edgeHealthy}/${edgeTotal} healthy | ${edgeStatus} |`,
              ''
            ];

            if (smokeResults.failed !== '0') {
              bodyLines.push('### âŒ Smoke Test ì‹¤íŒ¨');
              bodyLines.push(`${smokeResults.failed}ê°œì˜ ë¼ìš°íŠ¸ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
              bodyLines.push('');
            }

            if (parseInt(perfScore) < 50) {
              bodyLines.push('### âŒ ì„±ëŠ¥ ì €í•˜');
              bodyLines.push(`Performance scoreê°€ ${perfScore}ì ìœ¼ë¡œ ê¸°ì¤€(50ì ) ë¯¸ë‹¬ì…ë‹ˆë‹¤.`);
              bodyLines.push('');
            }

            if (failedFunctions && failedFunctions.trim()) {
              bodyLines.push('### âš ï¸ Edge Function ì´ìƒ');
              bodyLines.push('ë‹¤ìŒ í•¨ìˆ˜ë“¤ì´ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:');
              bodyLines.push('```');
              bodyLines.push(failedFunctions);
              bodyLines.push('```');
              bodyLines.push('');
            }

            bodyLines.push('### ì¡°ì¹˜ ë°©ë²•');
            bodyLines.push(`1. [ì›Œí¬í”Œë¡œìš° ë¡œê·¸ í™•ì¸](${runUrl})`);
            bodyLines.push('2. ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ë¶„ì„');
            bodyLines.push('3. ë¬¸ì œ ìˆ˜ì • í›„ ì¬í…ŒìŠ¤íŠ¸');
            bodyLines.push('');
            bodyLines.push('---');
            bodyLines.push('*ì´ ì´ìŠˆëŠ” QA ëª¨ë‹ˆí„°ë§ íŒŒì´í”„ë¼ì¸ì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*');

            const body = bodyLines.join('\n');

            // ë™ì¼í•œ ë‚ ì§œì˜ ì´ìŠˆê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'qa-failure',
              state: 'open'
            });

            const todayIssue = existingIssues.data.find(issue =>
              issue.title.includes(date)
            );

            if (todayIssue) {
              // ê¸°ì¡´ ì´ìŠˆì— ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: `## ğŸ“ ì¶”ê°€ ì‹¤íŒ¨ ë³´ê³ \n\n${body}`
              });
              console.log(`Updated existing issue #${todayIssue.number}`);
            } else {
              // ìƒˆ ì´ìŠˆ ìƒì„±
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ QA í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - ${date}`,
                body: body,
                labels: ['bug', 'qa-failure', 'automated']
              });
              console.log(`Created new issue #${issue.data.number}`);
            }

  # =====================================================
  # Job 6: Slack ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œ)
  # =====================================================
  notify-slack:
    name: Slack Notification
    needs: [smoke-tests, performance-tests, edge-function-health]
    if: always() && (needs.smoke-tests.result == 'failure' || needs.performance-tests.result == 'failure' || needs.edge-function-health.result == 'failure')
    uses: ./.github/workflows/slack-notify.yml
    with:
      workflow_name: "QA Monitoring"
      job_status: "failure"
      failed_jobs: "${{ needs.smoke-tests.result == 'failure' && 'smoke-tests ' || '' }}${{ needs.performance-tests.result == 'failure' && 'performance ' || '' }}${{ needs.edge-function-health.result == 'failure' && 'edge-functions' || '' }}"
      custom_message: "Performance: ${{ needs.performance-tests.outputs.performance_score || 'N/A' }}/100 | Edge: ${{ needs.edge-function-health.outputs.healthy || '?' }}/${{ needs.edge-function-health.outputs.total || '?' }}"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

name: E2E Tests

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type'
        required: false
        default: 'smoke'
        type: choice
        options:
          - smoke
          - all
          - comprehensive

env:
  FLUTTER_VERSION: '3.38.0'
  NODE_VERSION: '20.x'

jobs:
  # =====================================================
  # Job 1: ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ (ëª¨ë“  ë¼ìš°íŠ¸ ê¸°ë³¸ ê²€ì¦)
  # =====================================================
  smoke-tests:
    name: Smoke Tests (50+ Routes)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      attempts: ${{ steps.e2e-run.outputs.attempts }}
      run1_exit: ${{ steps.e2e-run.outputs.run1_exit }}
      run1_passed: ${{ steps.e2e-run.outputs.run1_passed }}
      run1_failed: ${{ steps.e2e-run.outputs.run1_failed }}
      run2_exit: ${{ steps.e2e-run.outputs.run2_exit }}
      run2_passed: ${{ steps.e2e-run.outputs.run2_passed }}
      run2_failed: ${{ steps.e2e-run.outputs.run2_failed }}
      run_summary_file: ${{ steps.e2e-run.outputs.run_summary_file }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Node dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Setup test environment
        run: |
          cp .env.test .env
          mkdir -p assets/images/character/lunch assets/decorations assets/icons/traditional assets/animations
          touch assets/images/character/lunch/.gitkeep assets/decorations/.gitkeep assets/icons/traditional/.gitkeep assets/animations/.gitkeep

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build Flutter Web
        run: flutter build web --release

      - name: Run Smoke Tests
        id: e2e-run
        run: |
          set -uo pipefail

          RUN_COMMAND='npm run test:e2e'
          SUMMARY_FILE='artifacts/run-summary.md'
          RUN1_EXIT=1
          RUN1_PASSED=0
          RUN1_FAILED=1
          RUN2_EXIT=1
          RUN2_PASSED=0
          RUN2_FAILED=1
          TOTAL_ATTEMPTS=1

          mkdir -p artifacts/e2e-attempt-1 artifacts/e2e-attempt-2 artifacts
          {
            echo "# Playwright E2E Retry Log"
            echo "| Attempt | Exit | Passed | Failed | Started (UTC) | Finished (UTC) |"
            echo "|---|---|---|---|---|---|"
          } > "$SUMMARY_FILE"

          run_once() {
            local attempt="$1"
            local artifact_dir="artifacts/e2e-attempt-${attempt}"
            local exit_code=1
            local passed_count=0
            local failed_count=1
            local start_at
            local finish_at

            rm -rf test-results playwright-report
            mkdir -p "$artifact_dir"

            start_at="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            if $RUN_COMMAND 2>&1 | tee "$artifact_dir/command.log"; then
              exit_code=0
            else
              exit_code=$?
            fi
            finish_at="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

            if [ -f test-results/results.json ]; then
              passed_count=$(jq '.stats.expected // 0' test-results/results.json)
              failed_count=$(jq '.stats.unexpected // 0' test-results/results.json)
            else
              passed_count=0
              failed_count=1
            fi

            mkdir -p "$artifact_dir"
            cp -R test-results playwright-report "$artifact_dir/" || true
            cp test-results/results.json "$artifact_dir/run-results.json" 2>/dev/null || true

            printf '%s\n' \
              '{' \
              "  \"attempt\": ${attempt}," \
              "  \"command\": \"${RUN_COMMAND}\"," \
              "  \"exitCode\": ${exit_code}," \
              "  \"passed\": ${passed_count}," \
              "  \"failed\": ${failed_count}," \
              "  \"startedAt\": \"${start_at}\"," \
              "  \"finishedAt\": \"${finish_at}\"" \
              '}' > "$artifact_dir/run-summary.json"

            echo "| ${attempt} | ${exit_code} | ${passed_count} | ${failed_count} | ${start_at} | ${finish_at} |" >> "$SUMMARY_FILE"

            if [ "$attempt" = "1" ]; then
              RUN1_EXIT=$exit_code
              RUN1_PASSED=$passed_count
              RUN1_FAILED=$failed_count
            else
              RUN2_EXIT=$exit_code
              RUN2_PASSED=$passed_count
              RUN2_FAILED=$failed_count
            fi
          }

          run_once 1

          if [ "$RUN1_EXIT" -ne 0 ] || [ "$RUN1_FAILED" -ne 0 ]; then
            echo "1ì°¨ ì‹¤í–‰ ì‹¤íŒ¨ë¡œ ì¸í•´ 2ì°¨ ì‹¤í–‰ì„ ì‹œì‘í•©ë‹ˆë‹¤." | tee -a "$SUMMARY_FILE"
            run_once 2
            TOTAL_ATTEMPTS=2
          fi

          echo "attempts=$TOTAL_ATTEMPTS" >> "$GITHUB_OUTPUT"
          echo "run1_exit=$RUN1_EXIT" >> "$GITHUB_OUTPUT"
          echo "run1_passed=$RUN1_PASSED" >> "$GITHUB_OUTPUT"
          echo "run1_failed=$RUN1_FAILED" >> "$GITHUB_OUTPUT"
          echo "run2_exit=$RUN2_EXIT" >> "$GITHUB_OUTPUT"
          echo "run2_passed=$RUN2_PASSED" >> "$GITHUB_OUTPUT"
          echo "run2_failed=$RUN2_FAILED" >> "$GITHUB_OUTPUT"
          echo "run_summary_file=$SUMMARY_FILE" >> "$GITHUB_OUTPUT"

          if [ "$TOTAL_ATTEMPTS" -eq 2 ] && [ "$RUN2_EXIT" -ne 0 ] || [ "$TOTAL_ATTEMPTS" -eq 2 ] && [ "$RUN2_FAILED" -ne 0 ]; then
            echo "ìµœì¢… ì‹¤í–‰ ì‹¤íŒ¨"
            cat "$SUMMARY_FILE"
            exit 1
          fi

          if [ "$TOTAL_ATTEMPTS" -eq 1 ] && ( [ "$RUN1_EXIT" -ne 0 ] || [ "$RUN1_FAILED" -ne 0 ] ); then
            echo "ìµœì¢… ì‹¤í–‰ ì‹¤íŒ¨"
            cat "$SUMMARY_FILE"
            exit 1
          fi

          echo "ìµœì¢… ì‹¤í–‰ ì„±ê³µ"
          cat "$SUMMARY_FILE"
        env:
          CI: true
          BASE_URL: http://localhost:3000

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.run_id }}
          path: |
            artifacts/e2e-attempt-1
            artifacts/e2e-attempt-2
            artifacts/run-summary.md
          retention-days: 7

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-screenshots-${{ github.run_id }}
          path: test-results/smoke/
          retention-days: 7

  # =====================================================
  # Job 2: PR ì‹¤íŒ¨ ì‹œ ì½”ë©˜íŠ¸ ì¶”ê°€
  # =====================================================
  comment-on-failure:
    name: Comment on PR (if failed)
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: failure() && github.event_name == 'pull_request'

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = [
              '## âŒ E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨',
              '',
              'ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ì—ì„œ ì‹¤íŒ¨ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.',
              '',
              '**ìƒì„¸ ì •ë³´:**',
              `- ì‹¤í–‰ ID: \`${context.runId}\``,
              `- ì»¤ë°‹: \`${context.sha.substring(0, 7)}\``,
              '',
              `[ğŸ” í…ŒìŠ¤íŠ¸ ê²°ê³¼ í™•ì¸](${runUrl})`,
              '',
              '---',
              '*ì´ ì½”ë©˜íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # =====================================================
  # Job 3: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
  # =====================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: ./report
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "## ğŸ§ª E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "| Attempt | Exit | Passed | Failed |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | ${{ needs['smoke-tests'].outputs.run1_exit }} | ${{ needs['smoke-tests'].outputs.run1_passed }} | ${{ needs['smoke-tests'].outputs.run1_failed }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs['smoke-tests'].outputs.attempts }}" = "2" ]; then
            echo "| 2 | ${{ needs['smoke-tests'].outputs.run2_exit }} | ${{ needs['smoke-tests'].outputs.run2_passed }} | ${{ needs['smoke-tests'].outputs.run2_failed }} |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run count: ${{ needs['smoke-tests'].outputs.attempts }} of 2 max" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "./report/${{ needs['smoke-tests'].outputs.run_summary_file }}" ]; then
            echo "### Run Log" >> $GITHUB_STEP_SUMMARY
            cat ./report/${{ needs['smoke-tests'].outputs.run_summary_file }} >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ì‹¤í–‰ ë¡œê·¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by E2E Tests workflow*" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # Job 4: Slack ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œ)
  # =====================================================
  notify-slack:
    name: Slack Notification
    needs: [smoke-tests]
    if: always() && needs['smoke-tests'].result == 'failure'
    uses: ./.github/workflows/slack-notify.yml
    with:
      workflow_name: "E2E Tests"
      job_status: "failure"
      failed_jobs: "smoke-tests"
      pr_number: "${{ github.event.pull_request.number || '' }}"
      custom_message: "50+ ë¼ìš°íŠ¸ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

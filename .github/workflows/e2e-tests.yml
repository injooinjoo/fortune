name: E2E Tests

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type'
        required: false
        default: 'smoke'
        type: choice
        options:
          - smoke
          - all
          - comprehensive

env:
  FLUTTER_VERSION: '3.38.0'
  NODE_VERSION: '20.x'

jobs:
  # =====================================================
  # Job 1: ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ (ëª¨ë“  ë¼ìš°íŠ¸ ê¸°ë³¸ ê²€ì¦)
  # =====================================================
  smoke-tests:
    name: Smoke Tests (50+ Routes)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Node dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Setup test environment
        run: |
          cp .env.test .env
          mkdir -p assets/images/character/lunch assets/decorations assets/icons/traditional assets/animations
          touch assets/images/character/lunch/.gitkeep assets/decorations/.gitkeep assets/icons/traditional/.gitkeep assets/animations/.gitkeep

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build Flutter Web
        run: flutter build web --release

      - name: Run Smoke Tests
        run: |
          # ìˆ˜ë™ìœ¼ë¡œ ì„œë²„ ì‹œì‘ (Playwright webServer ëŒ€ì‹ )
          npx serve build/web -l 3000 &
          SERVER_PID=$!

          # ì„œë²„ ì¤€ë¹„ ëŒ€ê¸°
          echo "Waiting for server to be ready..."
          npx wait-on http://localhost:3000 --timeout 60000

          # ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (grepìœ¼ë¡œ í•„í„°)
          npx playwright test --grep "Smoke" \
            --project=chromium \
            --reporter=html,json,github || TEST_RESULT=$?

          # ì„œë²„ ì¢…ë£Œ
          kill $SERVER_PID 2>/dev/null || true

          exit ${TEST_RESULT:-0}
        env:
          CI: true
          BASE_URL: http://localhost:3000
          PLAYWRIGHT_SKIP_WEBSERVER: "true"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.run_id }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-screenshots-${{ github.run_id }}
          path: test-results/smoke/
          retention-days: 7

  # =====================================================
  # Job 2: PR ì‹¤íŒ¨ ì‹œ ì½”ë©˜íŠ¸ ì¶”ê°€
  # =====================================================
  comment-on-failure:
    name: Comment on PR (if failed)
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: failure() && github.event_name == 'pull_request'

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = [
              '## âŒ E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨',
              '',
              'ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ì—ì„œ ì‹¤íŒ¨ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.',
              '',
              '**ìƒì„¸ ì •ë³´:**',
              `- ì‹¤í–‰ ID: \`${context.runId}\``,
              `- ì»¤ë°‹: \`${context.sha.substring(0, 7)}\``,
              '',
              `[ğŸ” í…ŒìŠ¤íŠ¸ ê²°ê³¼ í™•ì¸](${runUrl})`,
              '',
              '---',
              '*ì´ ì½”ë©˜íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*'
            ].join('\n');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # =====================================================
  # Job 3: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
  # =====================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: ./report
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "## ğŸ§ª E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "./report/results.json" ]; then
            PASSED=$(jq '.stats.expected // 0' ./report/results.json 2>/dev/null || echo "0")
            FAILED=$(jq '.stats.unexpected // 0' ./report/results.json 2>/dev/null || echo "0")
            TOTAL=$((PASSED + FAILED))

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ“Š Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by E2E Tests workflow*" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # Job 4: Slack ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œ)
  # =====================================================
  notify-slack:
    name: Slack Notification
    needs: [smoke-tests]
    if: always() && needs.smoke-tests.result == 'failure'
    uses: ./.github/workflows/slack-notify.yml
    with:
      workflow_name: "E2E Tests"
      job_status: "failure"
      failed_jobs: "smoke-tests"
      pr_number: "${{ github.event.pull_request.number || '' }}"
      custom_message: "50+ ë¼ìš°íŠ¸ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

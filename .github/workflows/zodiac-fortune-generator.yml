name: Daily Zodiac Age Fortune Generation

on:
  schedule:
    # Run daily at midnight KST (15:00 UTC)
    - cron: '0 15 * * *'
  workflow_dispatch:
    inputs:
      year:
        description: 'Year for fortune generation (defaults to current year)'
        required: false
        type: number

permissions:
  contents: read
  issues: write

jobs:
  generate-zodiac-fortunes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Generate Zodiac Age Fortunes
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        # Set year (use input or current year)
        YEAR="${{ github.event.inputs.year }}"
        if [ -z "$YEAR" ]; then
          YEAR=$(date +%Y)
        fi
        
        echo "Generating zodiac age fortunes for year: $YEAR"
        
        # Call the edge function
        RESPONSE=$(curl -X POST \
          "${SUPABASE_URL}/functions/v1/fortune-zodiac-scheduler" \
          -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
          -H "Content-Type: application/json" \
          -d "{\"action\": \"generate_daily\", \"year\": $YEAR}" \
          -w "\n%{http_code}")
        
        # Extract HTTP status code
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')
        
        echo "Response body: $BODY"
        echo "HTTP status code: $HTTP_CODE"
        
        # Check if successful
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "‚úÖ Fortune generation completed successfully"
          
          # Parse and display statistics
          SUCCESS=$(echo "$BODY" | jq -r '.stats.successful // 0')
          FAILED=$(echo "$BODY" | jq -r '.stats.failed // 0')
          CACHED=$(echo "$BODY" | jq -r '.stats.cached // 0')
          GENERATED=$(echo "$BODY" | jq -r '.stats.generated // 0')
          
          echo "üìä Statistics:"
          echo "  - Successful: $SUCCESS"
          echo "  - Failed: $FAILED"
          echo "  - Cached: $CACHED"
          echo "  - Generated: $GENERATED"
        else
          echo "‚ùå Fortune generation failed with status code: $HTTP_CODE"
          exit 1
        fi
    
    - name: Create Issue on Repeated Failures
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          // Check if there's already an open issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['zodiac-fortune-generation', 'automated']
          });
          
          if (issues.data.length === 0) {
            // Create a new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Zodiac Fortune Generation Failed',
              body: `The daily zodiac fortune generation workflow failed.
              
              **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              **Date:** ${new Date().toISOString()}
              
              Please investigate and fix the issue.`,
              labels: ['zodiac-fortune-generation', 'automated', 'bug']
            });
          }

  # Slack ÏïåÎ¶º (Ïû¨ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏõåÌÅ¨ÌîåÎ°úÏö∞Î°ú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò)
  notify-slack:
    name: Slack Notification
    needs: [generate-zodiac-fortunes]
    if: always() && needs.generate-zodiac-fortunes.result == 'failure'
    uses: ./.github/workflows/slack-notify.yml
    with:
      workflow_name: "Daily Zodiac Fortune Generator"
      job_status: "failure"
      failed_jobs: "generate-zodiac-fortunes"
      custom_message: "ÏùºÏùº Ïö¥ÏÑ∏ ÏÉùÏÑ± Ïã§Ìå®! Edge Function ÌôïÏù∏ ÌïÑÏöî."
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
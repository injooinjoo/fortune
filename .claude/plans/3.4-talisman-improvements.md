# [3.4] 부적 개선 기획서

## 1. 요구사항

| 항목 | 설명 | 복잡도 |
|------|------|--------|
| 3.4.1 | 유료화 (광고/복채) | 중간 |
| 3.4.2 | 완성 페이지 뒤로가기 버튼 추가 | 낮음 |

---

## 2. 현황 분석

### 2.1 현재 구현 상태

**파일 구조**:
```
lib/features/
├── talisman/
│   ├── presentation/
│   │   ├── providers/talisman_provider.dart
│   │   └── widgets/
│   │       ├── talisman_result_card.dart
│   │       └── talisman_premium_bottom_sheet.dart
│   └── data/services/talisman_service.dart
└── fortune/presentation/pages/talisman_fortune_page.dart (메인 페이지)
```

**현재 Flow**:
1. `categorySelection`: 소원 카테고리 선택
2. `wishInput`: 구체적 소원 입력
3. `generation`: 부적 생성 중 (애니메이션)
4. `result`: 결과 표시 (저장/공유/배경화면 버튼)

### 2.2 현재 제한 시스템
- `dailyTalismanLimitProvider`: 무료 사용자 하루 1개 제한
- 제한 초과 시 `TalismanPremiumBottomSheet` 표시
- 구독(월 4,900원) 또는 일회 구매(1,900원) 옵션

### 2.3 현재 결과 페이지 네비게이션
- AppBar leading: `null` (뒤로가기 버튼 없음)
- AppBar actions: X 버튼 (페이지 닫기)
- 결과 페이지에서 "새 부적 만들기" 옵션 없음

---

## 3. 구현 계획

### 3.4.1 유료화 개선 - 광고 옵션 추가

**목표**: 무료 사용자가 광고를 시청하고 추가 부적 생성 가능

**구현 방법**:

1. **Premium Bottom Sheet 수정**: 광고 시청 옵션 추가
```dart
// talisman_premium_bottom_sheet.dart에 추가
final VoidCallback? onWatchAd;

// UI에 광고 시청 버튼 추가
UnifiedButton(
  text: '광고 보고 무료로 만들기',
  onPressed: onWatchAd,
  style: UnifiedButtonStyle.tertiary,
  icon: Icon(Icons.play_circle_outline),
),
```

2. **메인 페이지에서 광고 처리**:
```dart
// talisman_fortune_page.dart
Future<void> _showPremiumBottomSheet(BuildContext context) async {
  await TalismanPremiumBottomSheet.show(
    context,
    onSubscribe: () => ...,
    onOneTimePurchase: () => ...,
    onWatchAd: () async {
      Navigator.of(context).pop();
      await _handleWatchAd();
    },
  );
}

Future<void> _handleWatchAd() async {
  // 리워드 광고 표시 후 부적 생성 진행
}
```

### 3.4.2 완성 페이지 뒤로가기 버튼

**목표**: 결과 페이지에서 "새 부적 만들기" 버튼으로 처음부터 다시 시작

**현재 코드 (line 46-66)**:
```dart
leading: talismanState.step == TalismanGenerationStep.result
    ? null  // 결과 페이지면 leading 없음
    : _buildBackButton(...),
actions: talismanState.step == TalismanGenerationStep.result
    ? [IconButton(icon: Icon(Icons.close), ...)]  // X 버튼만
    : null,
```

**수정 방안**:
```dart
// 결과 페이지에서도 leading 표시 (새 부적 만들기)
leading: _buildBackButton(context, ref, talismanState.step, userId, colors),
// 결과 페이지에서는 "새로 만들기" 아이콘으로 변경
```

**또는 TalismanResultCard에 "새 부적 만들기" 버튼 추가**:
```dart
// talisman_result_card.dart 하단에 추가
UnifiedButton(
  text: '새 부적 만들기',
  onPressed: onCreateNew,
  style: UnifiedButtonStyle.text,
  icon: Icon(Icons.add_circle_outline),
),
```

---

## 4. 구현 순서

### Phase 1: 뒤로가기 버튼 (3.4.2)
1. [x] 현재 코드 분석 완료
2. [ ] talisman_fortune_page.dart에서 결과 페이지 leading 복원
3. [ ] goBack() 로직 확인 (result → categorySelection)

### Phase 2: 광고 옵션 (3.4.1)
4. [ ] TalismanPremiumBottomSheet에 onWatchAd 콜백 추가
5. [ ] 광고 시청 버튼 UI 추가
6. [ ] talisman_fortune_page.dart에서 리워드 광고 처리
7. [ ] 광고 시청 성공 시 제한 우회 로직

---

## 5. 체크리스트

### 3.4.2 뒤로가기 버튼
- [ ] 결과 페이지 AppBar leading 수정 (refresh 아이콘)
- [ ] 터치 시 reset() 호출로 처음부터 시작
- [ ] X 버튼은 유지 (페이지 종료용)

### 3.4.1 광고 옵션
- [ ] TalismanPremiumBottomSheet에 onWatchAd 파라미터 추가
- [ ] 광고 버튼 UI 추가 (세 번째 옵션)
- [ ] _handleWatchAd() 메서드 구현
- [ ] AdService 리워드 광고 연동
- [ ] 광고 성공 후 부적 생성 진행

---

## 6. 예상 소요 시간

| 항목 | 예상 시간 |
|------|----------|
| 3.4.2 뒤로가기 버튼 | 10분 |
| 3.4.1 광고 옵션 추가 | 25분 |
| 테스트 | 10분 |
| **합계** | **45분** |

---
**작성일**: 2025-12-17
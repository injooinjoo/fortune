# 설계계획서: 2.1.1 생년월일 분 단위 지원

## ✅ 완료 (2025-12-17)

**수정 파일**: `lib/screens/onboarding/steps/birth_input_step.dart`

**변경 사항**:
1. `_minuteController`, `_minuteFocus` 추가
2. 분 입력 리스너 및 백스페이스 처리 추가
3. 시간 2자리 입력 시 분 필드로 자동 이동
4. UI에 분 입력 필드 추가 (`[ 14 ] 시 [ 30 ] 분`)
5. `_onTimeChanged`에서 분 포함하여 `TimeOfDay` 전달
6. "모르겠어요" 선택 시 분 컨트롤러 초기화

---

## 1. 현황 분석

### 1.1 현재 시스템 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                      시간 입력 경로                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [온보딩]                    [프로필 편집]                       │
│  birth_input_step.dart       profile_edit_page.dart             │
│  ↓                           ↓                                  │
│  시간만 입력 (0-23)          NumericTimeInput (HH:MM)           │
│  minute = 0 고정             ↓                                  │
│  ↓                           birth_time_edit_dialog.dart        │
│  "14:00" 형식                ↓                                  │
│                              2시간 범위 선택 (축시, 인시...)     │
│                              "축시 (01:00-03:00)" 형식          │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                      DB 저장 (user_profiles)                     │
├─────────────────────────────────────────────────────────────────┤
│  birth_time (text): "14:00" 또는 "축시 (01:00-03:00)"           │
├─────────────────────────────────────────────────────────────────┤
│                      운세 계산 (Edge Functions)                  │
├─────────────────────────────────────────────────────────────────┤
│  calculate-saju: hour만 추출 → 시주 계산                        │
│  fortune-time: hour 기반 시간대별 운세                          │
│  ※ 분(minute) 데이터는 모두 무시됨                              │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 핵심 문제점

| 구분 | 문제 | 영향도 |
|------|------|--------|
| 온보딩 | `minute = 0` 하드코딩 (Line 208) | 높음 |
| 시간 다이얼로그 | 2시간 범위만 선택 가능 | 중간 |
| 운세 계산 | 분 데이터 무시 | 낮음 |
| DB | text 타입으로 형식 불일치 | 낮음 |

### 1.3 사주 관점에서의 분석

**중요 발견**: 전통 사주에서 **시주(時柱)**는 2시간 단위(12지지 기준)로 계산됨

```
자시: 23:00-01:00  |  오시: 11:00-13:00
축시: 01:00-03:00  |  미시: 13:00-15:00
인시: 03:00-05:00  |  신시: 15:00-17:00
묘시: 05:00-07:00  |  유시: 17:00-19:00
진시: 07:00-09:00  |  술시: 19:00-21:00
사시: 09:00-11:00  |  해시: 21:00-23:00
```

→ **결론**: 사주 계산에는 분 단위가 필요 없음. 2시간 범위 내 동일한 시주.

---

## 2. 요구사항 재정의

### 2.1 원본 요구사항
> "생년월일 분 단위 | ✅ 이미 지원 | 검증만 필요"

### 2.2 실제 분석 결과
- **온보딩**: ❌ 분 단위 미지원 (minute=0 고정)
- **프로필 편집**: ⚠️ 부분 지원 (NumericTimeInput은 분 입력 가능하나 시간 다이얼로그는 2시간 범위만)
- **운세 계산**: ❌ 분 데이터 미사용

### 2.3 핵심 질문

**Q: 분 단위 지원이 정말 필요한가?**

| 관점 | 분석 |
|------|------|
| 사주 정확도 | 2시간 범위 내 동일 → 분 무의미 |
| 사용자 경험 | 정확한 시간 입력 → 신뢰감 증가 |
| 경쟁 앱 | 대부분 시간 단위 또는 2시간 범위 |
| 구현 복잡도 | 낮음 (UI 수정만 필요) |

**A: UX 관점에서 분 단위 입력은 선택적 가치. 사주 정확도에는 영향 없음.**

---

## 3. 개선안 (3가지 옵션)

### Option A: 현행 유지 (권장)
- **변경 없음**
- 사주는 2시간 범위 기반이므로 분 단위 불필요
- 사용자에게 "시간대 선택" UI가 더 직관적

**장점**: 개발 비용 0, 사주 원리에 부합
**단점**: 일부 사용자의 정밀 입력 욕구 미충족

### Option B: 온보딩 분 단위 추가
- `birth_input_step.dart` 수정
- 시간 입력 후 분 입력 필드 추가
- `TimeOfDay(hour: hour, minute: minute)` 전달

**장점**: 정밀한 시간 기록
**단점**: 온보딩 단계 증가, 사주 계산에 무의미

### Option C: 하이브리드 접근
- **온보딩**: 시간만 입력 (현행 유지)
- **프로필 편집**: 분 단위 수정 가능 (NumericTimeInput 활용)
- **시간 다이얼로그**: 2시간 범위 선택 유지
- UI에 "상세 시간 (선택)" 토글 추가

**장점**: 유연성, 사용자 선택권
**단점**: UI 복잡도 증가

---

## 4. 결정 및 실행 계획

### 4.1 권장안: Option A (현행 유지)

**근거**:
1. 사주 계산에 분 단위 불필요 (전통 역학 원리)
2. 한국 전통 시간 체계(12시진)와 일관성
3. 불필요한 개발 비용 방지
4. 기존 사용자 데이터와의 호환성

### 4.2 대안 실행 시 (Option B 선택 시)

#### 수정 파일
```
lib/screens/onboarding/steps/birth_input_step.dart
├── Line 70: 초기 분 상태 추가
├── Line 202-226: 분 입력 리스너 추가
└── Line 208: minute 파라미터 동적 처리
```

#### 코드 변경

**Before (Line 208)**:
```dart
widget.onBirthTimeChanged?.call(TimeOfDay(hour: hour, minute: 0));
```

**After**:
```dart
widget.onBirthTimeChanged?.call(TimeOfDay(hour: hour, minute: _minute));
```

#### UI 변경
- 시간 입력 필드 옆에 ":" 구분자 추가
- 분 입력 필드 (00-59) 추가
- 분 입력은 선택적 (미입력 시 00)

---

## 5. 검증 항목

### 5.1 현행 시스템 검증 (Option A)

| 검증 항목 | 방법 | 예상 결과 |
|-----------|------|-----------|
| 온보딩 시간 저장 | 14시 입력 → DB 확인 | "14:00" |
| 프로필 시간 수정 | 15:30 입력 → DB 확인 | "15:30" |
| 시간 다이얼로그 | 축시 선택 → DB 확인 | "축시 (01:00-03:00)" |
| 사주 계산 | 14:00, 14:30, 14:59 → 시주 비교 | 모두 동일 (미시) |

### 5.2 사주 시주 일관성 테스트

```
입력: 13:00 → 시주: 미시 (午時) ✓
입력: 13:30 → 시주: 미시 (午時) ✓
입력: 13:59 → 시주: 미시 (午時) ✓
입력: 14:00 → 시주: 미시 (午時) ✓
입력: 14:59 → 시주: 미시 (午時) ✓
```

---

## 6. 최종 결론

### 6.1 현황
- **기술적으로**: 분 단위 입력은 프로필 편집에서 부분 지원
- **실질적으로**: 운세 계산에 분 데이터 미사용

### 6.2 권장 조치
1. **개발 불필요**: 현행 시스템이 사주 계산 요구사항 충족
2. **문서화**: 사용자에게 "시간 범위 기반 계산" 안내 추가 (선택)
3. **향후**: 서양 점성술 기능 추가 시 분 단위 재검토

### 6.3 사용자 커뮤니케이션 (선택)
온보딩 또는 프로필 편집 시 안내 문구:
> "출생 시간은 2시간 단위(시진)로 운세에 반영됩니다"

---

## 7. 실행 결정

**[ ] Option A: 현행 유지**
**[x] Option B: 온보딩 분 단위 추가** ← 선택 (고객 요구사항)
**[ ] Option C: 하이브리드 접근**

**결정 근거**: 사주 계산에는 분 단위가 불필요하나, 고객이 정확한 출생시간을 기록하고 싶어함

---

## 8. 구현 계획 (Option B)

### 8.1 수정 대상 파일

| 파일 | 수정 내용 |
|------|----------|
| `birth_input_step.dart` | 분 입력 UI 추가, minute 변수 처리 |

### 8.2 UI 변경 설계

**Before**:
```
┌─────────────────────────┐
│  출생 시간을 입력하세요    │
│                         │
│      [ 14 ] 시          │
│                         │
└─────────────────────────┘
```

**After**:
```
┌─────────────────────────┐
│  출생 시간을 입력하세요    │
│                         │
│   [ 14 ] 시 [ 30 ] 분   │
│                         │
└─────────────────────────┘
```

### 8.3 코드 변경 사항

1. `_minute` 상태 변수 추가
2. `_minuteController` 텍스트 컨트롤러 추가
3. 분 입력 필드 UI 추가
4. `TimeOfDay(hour: hour, minute: _minute)` 전달
5. 분 유효성 검증 (0-59)

### 8.4 저장 형식

- **Before**: `"14:00"` (분 항상 00)
- **After**: `"14:30"` (실제 입력값)

### 8.5 영향 범위

| 시스템 | 영향 | 조치 |
|--------|------|------|
| DB 저장 | 형식 동일 (HH:MM) | 없음 |
| 사주 계산 | 분 무시 (기존) | 없음 |
| 프로필 표시 | 정확한 시간 표시 | 없음 |

---

## 부록: 관련 파일 목록

| 파일 | 역할 | 수정 필요 |
|------|------|-----------|
| `lib/screens/onboarding/steps/birth_input_step.dart` | 온보딩 시간 입력 | Option B 시 |
| `lib/screens/profile/profile_edit_page.dart` | 프로필 시간 수정 | 불필요 |
| `lib/presentation/widgets/profile_edit_dialogs/birth_time_edit_dialog.dart` | 시간대 선택 | 불필요 |
| `supabase/functions/calculate-saju/index.ts` | 사주 계산 | 불필요 |
| `supabase/functions/fortune-time/index.ts` | 시간별 운세 | 불필요 |
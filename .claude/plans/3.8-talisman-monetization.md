# [3.8] ë¶€ì  ìœ ë£Œí™” ê¸°íšì„œ

## 1. ìš”êµ¬ì‚¬í•­

| í•­ëª© | ì„¤ëª… | ë³µì¡ë„ |
|------|------|--------|
| 3.8.1 | ë¶€ì  ìƒì„± ì „ ê´‘ê³  ì‹œì²­ ë˜ëŠ” ë³µì±„(í† í°) ì°¨ê° | ì¤‘ê°„ |
| 3.8.2 | í”„ë¦¬ë¯¸ì—„ êµ¬ë…ìëŠ” ë¬´ì œí•œ ì´ìš© | ë‚®ìŒ |

---

## 2. í˜„í™© ë¶„ì„

### 2.1 í˜„ì¬ êµ¬í˜„
- ë¶€ì  ìƒì„±: ë¬´ë£Œ (ì œí•œ ì—†ìŒ)
- AI ì´ë¯¸ì§€ ìƒì„±: ì„ íƒ ì‚¬í•­
- í† í° ì‹œìŠ¤í…œ: ë‹¤ë¥¸ ìš´ì„¸ì—ì„œ ì‚¬ìš© ì¤‘

### 2.2 ê´€ë ¨ íŒŒì¼
```
lib/features/fortune/presentation/pages/
â””â”€â”€ talisman_fortune_page.dart

lib/presentation/providers/
â”œâ”€â”€ token_provider.dart (í† í° ê´€ë¦¬)
â””â”€â”€ subscription_provider.dart (êµ¬ë… ìƒíƒœ)

lib/services/
â””â”€â”€ ad_service.dart (ê´‘ê³  ì„œë¹„ìŠ¤)
```

### 2.3 ê¸°ì¡´ ìœ ë£Œí™” íŒ¨í„´ (ë‹¤ë¥¸ ìš´ì„¸ ì°¸ì¡°)

**Face Reading (ê´€ìƒ)**:
```dart
static const int _requiredTokens = 5;

// í† í° í™•ì¸
final tokenBalance = ref.read(tokenBalanceProvider);
if (tokenBalance.remainingTokens < _requiredTokens &&
    !tokenBalance.hasUnlimitedAccess) {
  _showInsufficientTokensModal();
  return;
}

// í† í° ì°¨ê°
await ref.read(tokenProvider.notifier).consumeTokens(
  fortuneType: 'face_reading',
  amount: _requiredTokens,
);
```

**MBTI (ê´‘ê³  í›„ ë¸”ëŸ¬ í•´ì œ)**:
```dart
Future<void> _showAdAndUnblur() async {
  final adService = AdService();
  await adService.showRewardedAd(
    onUserEarnedReward: (ad, reward) {
      setState(() {
        _fortuneResult = _fortuneResult!.copyWith(isBlurred: false);
      });
    },
  );
}
```

---

## 3. ìœ ë£Œí™” ëª¨ë¸ ì„¤ê³„

### 3.1 ê°€ê²© ì •ì±…

| ë°©ì‹ | ë¹„ìš© | ì„¤ëª… |
|------|------|------|
| ê´‘ê³  ì‹œì²­ | ë¬´ë£Œ | ë¦¬ì›Œë“œ ê´‘ê³  ì‹œì²­ í›„ 1íšŒ ìƒì„± |
| ë³µì±„ (í† í°) | 3ê°œ | í† í°ìœ¼ë¡œ ì¦‰ì‹œ ìƒì„± |
| êµ¬ë…ì | ë¬´ë£Œ | ë¬´ì œí•œ ìƒì„± |

### 3.2 UI íë¦„

```
ì¹´í…Œê³ ë¦¬ ì„ íƒ â†’ ì†Œì› ì…ë ¥ â†’ ìœ ë£Œí™” ê²Œì´íŠ¸ â†’ ìƒì„±
                              â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ë¶€ì  ìƒì„±í•˜ê¸°   â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                 â”‚
                    â”‚ [ğŸ“º ê´‘ê³  ë³´ê³    â”‚
                    â”‚   ë¬´ë£Œë¡œ ë§Œë“¤ê¸°] â”‚
                    â”‚                 â”‚
                    â”‚ [ğŸª™ ë³µì±„ 3ê°œë¡œ  â”‚
                    â”‚   ë°”ë¡œ ë§Œë“¤ê¸°]  â”‚
                    â”‚                 â”‚
                    â”‚ [â­ í”„ë¦¬ë¯¸ì—„    â”‚
                    â”‚   ë¬´ì œí•œ ì´ìš©]  â”‚
                    â”‚                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 êµ¬ë…ì ì²˜ë¦¬

```dart
// êµ¬ë…ìëŠ” ë°”ë¡œ ìƒì„±
if (ref.read(isPremiumProvider)) {
  _generateTalisman();
  return;
}

// ë¹„êµ¬ë…ìëŠ” ê²Œì´íŠ¸ í‘œì‹œ
_showPaymentGate();
```

---

## 4. ìƒì„¸ êµ¬í˜„

### 4.1 ê²°ì œ ê²Œì´íŠ¸ ìœ„ì ¯

```dart
class TalismanPaymentGate extends ConsumerWidget {
  final VoidCallback onAdWatched;
  final VoidCallback onTokenPaid;
  final VoidCallback onPremiumSelected;

  static const int requiredTokens = 3;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final tokenBalance = ref.watch(tokenBalanceProvider);
    final hasEnoughTokens = (tokenBalance?.remainingTokens ?? 0) >= requiredTokens;

    return Container(
      padding: EdgeInsets.all(24),
      child: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          Text('ë¶€ì  ìƒì„±í•˜ê¸°', style: headlineStyle),
          SizedBox(height: 8),
          Text('ì†Œì›ì„ ë‹´ì€ ë¶€ì ì„ ë§Œë“¤ì–´ ë“œë¦´ê²Œìš”'),
          SizedBox(height: 24),

          // ê´‘ê³  ì˜µì…˜
          _buildOptionCard(
            icon: Icons.play_circle_fill,
            title: 'ê´‘ê³  ë³´ê³  ë¬´ë£Œë¡œ ë§Œë“¤ê¸°',
            subtitle: '30ì´ˆ ê´‘ê³  ì‹œì²­',
            onTap: onAdWatched,
          ),

          SizedBox(height: 12),

          // í† í° ì˜µì…˜
          _buildOptionCard(
            icon: Icons.toll,
            title: 'ë³µì±„ ${requiredTokens}ê°œë¡œ ë°”ë¡œ ë§Œë“¤ê¸°',
            subtitle: hasEnoughTokens
              ? 'ë³´ìœ : ${tokenBalance?.remainingTokens ?? 0}ê°œ'
              : 'í† í° ë¶€ì¡±',
            onTap: hasEnoughTokens ? onTokenPaid : null,
            enabled: hasEnoughTokens,
          ),

          SizedBox(height: 12),

          // êµ¬ë… ì˜µì…˜
          _buildOptionCard(
            icon: Icons.workspace_premium,
            title: 'í”„ë¦¬ë¯¸ì—„ êµ¬ë…í•˜ê¸°',
            subtitle: 'ë¬´ì œí•œ ë¶€ì  ìƒì„±',
            onTap: onPremiumSelected,
            isPremium: true,
          ),
        ],
      ),
    );
  }
}
```

### 4.2 ê´‘ê³  ì²˜ë¦¬

```dart
Future<void> _handleAdOption() async {
  final adService = AdService();

  if (!adService.isRewardedAdReady) {
    // ë¡œë”© í‘œì‹œ
    _showLoadingDialog('ê´‘ê³ ë¥¼ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”...');
    await adService.loadRewardedAd();
    Navigator.pop(context);
  }

  await adService.showRewardedAd(
    onUserEarnedReward: (ad, reward) {
      _generateTalisman();
    },
  );
}
```

### 4.3 í† í° ì²˜ë¦¬

```dart
Future<void> _handleTokenOption() async {
  try {
    await ref.read(tokenProvider.notifier).consumeTokens(
      fortuneType: 'talisman',
      amount: TalismanPaymentGate.requiredTokens,
    );
    _generateTalisman();
  } catch (e) {
    Toast.show(context, message: 'í† í° ì°¨ê°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', type: ToastType.error);
  }
}
```

### 4.4 talisman_fortune_page.dart ìˆ˜ì •

```dart
// ê¸°ì¡´: ë°”ë¡œ ìƒì„±
void _onGeneratePressed() {
  _generateTalisman();
}

// ë³€ê²½: ìœ ë£Œí™” ê²Œì´íŠ¸ ì¶”ê°€
void _onGeneratePressed() {
  // êµ¬ë…ìëŠ” ë°”ë¡œ ìƒì„±
  if (ref.read(isPremiumProvider)) {
    _generateTalisman();
    return;
  }

  // ë¹„êµ¬ë…ìëŠ” ê²Œì´íŠ¸ í‘œì‹œ
  showModalBottomSheet(
    context: context,
    isScrollControlled: true,
    builder: (context) => TalismanPaymentGate(
      onAdWatched: () {
        Navigator.pop(context);
        _handleAdOption();
      },
      onTokenPaid: () {
        Navigator.pop(context);
        _handleTokenOption();
      },
      onPremiumSelected: () {
        Navigator.pop(context);
        _navigateToSubscription();
      },
    ),
  );
}
```

---

## 5. ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] TalismanPaymentGate ìœ„ì ¯ ìƒì„±
- [ ] ê´‘ê³  ì²˜ë¦¬ ë¡œì§ (_handleAdOption)
- [ ] í† í° ì²˜ë¦¬ ë¡œì§ (_handleTokenOption)
- [ ] talisman_fortune_page.dartì— ê²Œì´íŠ¸ ì—°ë™
- [ ] isPremiumProvider ì²´í¬ ì¶”ê°€
- [ ] í† í° ë¶€ì¡± ì‹œ UI ì²˜ë¦¬
- [ ] êµ¬ë… í˜ì´ì§€ ì—°ê²°
- [ ] flutter analyze ê²€ì¦

---

## 6. ì˜ˆìƒ ì†Œìš” ì‹œê°„

| í•­ëª© | ì˜ˆìƒ ì‹œê°„ |
|------|----------|
| TalismanPaymentGate ìœ„ì ¯ | 30ë¶„ |
| ê´‘ê³  ì²˜ë¦¬ ë¡œì§ | 15ë¶„ |
| í† í° ì²˜ë¦¬ ë¡œì§ | 15ë¶„ |
| í˜ì´ì§€ ì—°ë™ | 20ë¶„ |
| í…ŒìŠ¤íŠ¸ | 15ë¶„ |
| **í•©ê³„** | **95ë¶„** |

---

## 7. ì•± ë‚´ ìœ ì‚¬ êµ¬í˜„ ì°¸ì¡°

### TokenInsufficientModal
```
lib/shared/components/token_insufficient_modal.dart
```
- í† í° ë¶€ì¡± ì‹œ í‘œì‹œë˜ëŠ” ëª¨ë‹¬
- ê´‘ê³ /êµ¬ë… ì˜µì…˜ ì œê³µ

### Face Reading ìœ ë£Œí™”
```
lib/features/interactive/presentation/pages/face_reading_page.dart
```
- _requiredTokens, _analyzeImage()
- í† í° ì°¨ê° íŒ¨í„´

### MBTI ê´‘ê³  ë¸”ëŸ¬ í•´ì œ
```
lib/features/fortune/presentation/pages/mbti_fortune/mbti_fortune_page.dart
```
- _showAdAndUnblur()
- AdService.showRewardedAd() íŒ¨í„´

---

**ì‘ì„±ì¼**: 2025-12-17
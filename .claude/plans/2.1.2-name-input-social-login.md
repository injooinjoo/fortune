# 설계계획서: 2.1.2 이름 입력 - 소셜 로그인 스킵 확인

## ✅ 검증 완료 (2025-12-17)

**결론**: 현재 시스템이 이미 올바르게 동작함. 추가 개발 불필요.

---

## 1. 현황 분석

### 1.1 현재 시스템 흐름

```
소셜 로그인 (Apple/Google)
    ↓
콜백 페이지 (callback_page.dart)
    ├─ user_profiles에 프로필 생성/업데이트
    └─ userMetadata.full_name → name 필드 저장
    ↓
온보딩 페이지 (onboarding_page.dart Line 139-169)
    ├─ provider 확인 (appMetadata['provider'])
    ├─ isSocialLogin = (provider == 'apple' || provider == 'google')
    └─ isSocialLogin이면 무조건 이름 단계 스킵
    ↓
생년월일 입력 단계 (직접 이동)
```

### 1.2 핵심 코드 (onboarding_page.dart:139-169)

```dart
// [App Store Guideline 4.0] Skip name step for social login users
final provider = _currentUser?.appMetadata['provider'] as String?;
final isSocialLogin = provider == 'apple' || provider == 'google';

// For social login users: skip name step even if name is empty
if (isSocialLogin && mounted) {
  // If name is empty, use a default name
  if (_name.isEmpty || _name == '사용자') {
    _name = _currentUser?.email?.split('@').first ??
            (provider == 'apple' ? 'Apple 사용자' : 'Google 사용자');
  }

  // Skip to birth date step
  WidgetsBinding.instance.addPostFrameCallback((_) {
    if (mounted && _currentStep == 0) {
      setState(() => _currentStep = 1);
      _pageController.jumpToPage(1);
    }
  });
}
```

---

## 2. 스킵 로직 정리

### 2.1 사용자 유형별 동작

| 로그인 방식 | 이름 있음 | 이름 없음 | 동작 |
|------------|---------|---------|------|
| **Apple** | ✅ 스킵 | ✅ 스킵 (기본값 사용) | 무조건 스킵 |
| **Google** | ✅ 스킵 | ✅ 스킵 (기본값 사용) | 무조건 스킵 |
| **이메일** | ✅ 스킵 | ❌ 입력 필요 | 조건부 |
| **Kakao** | (비활성화) | (비활성화) | - |

### 2.2 이름 기본값 설정

이름이 없을 때 (`_name.isEmpty || _name == '사용자'`):

| 제공자 | 기본값 |
|--------|--------|
| Apple | 이메일 prefix 또는 'Apple 사용자' |
| Google | 이메일 prefix 또는 'Google 사용자' |
| 이메일 | (입력 필요) |

### 2.3 이름 우선순위 (onboarding_page.dart:93-96)

```dart
_name = existingProfile!['name'] ??           // 1. DB 저장 이름
    _currentUser?.userMetadata?['full_name'] ?? // 2. 소셜 full_name
    _currentUser?.userMetadata?['name'] ??      // 3. 소셜 name
    defaultName;                                // 4. 이메일 prefix
```

---

## 3. App Store Guideline 4.0 준수

### 3.1 Apple Sign In 정책

> "Apple Sign In은 첫 로그인에만 이름을 제공합니다. 이후 로그인에서는 이름이 제공되지 않습니다."

**현재 대응**:
- 이름 유무와 관계없이 무조건 스킵
- 이름 없으면 기본값 사용
- 사용자가 프로필에서 이름 수정 가능

### 3.2 코드 주석

```dart
// [App Store Guideline 4.0] Skip name step for social login users
// Apple Sign In only provides name on FIRST login, not on subsequent logins
// So we MUST skip name step for Apple/Google users regardless of whether name exists
```

---

## 4. 검증 결과

### 4.1 테스트 시나리오

| 시나리오 | 예상 결과 | 검증 |
|----------|----------|------|
| Apple 첫 로그인 (이름 있음) | 이름 저장 → 스킵 | ✅ |
| Apple 재로그인 (이름 없음) | 기본값 → 스킵 | ✅ |
| Google 로그인 (이름 있음) | 이름 저장 → 스킵 | ✅ |
| Google 로그인 (이름 없음) | 기본값 → 스킵 | ✅ |
| 이메일 가입 (이름 없음) | 이름 입력 단계 표시 | ✅ |

### 4.2 코드 확인 위치

| 파일 | 라인 | 역할 |
|------|------|------|
| `onboarding_page.dart` | 139-169 | 스킵 로직 |
| `onboarding_page.dart` | 93-96 | 이름 우선순위 |
| `callback_page.dart` | 61-92 | 프로필 생성 |
| `apple_auth_provider.dart` | 72-82 | Apple 이름 추출 |
| `google_auth_provider.dart` | 30-36 | Google OAuth |

---

## 5. 결론

### 5.1 현황

- **소셜 로그인 스킵**: ✅ 이미 구현됨
- **기본값 처리**: ✅ 이미 구현됨
- **App Store 준수**: ✅ 주석으로 명시됨

### 5.2 조치사항

**추가 개발 불필요** - 현재 시스템이 요구사항을 충족함.

### 5.3 향후 고려사항 (선택)

1. **Kakao 로그인 활성화 시**: nickname 처리 로직 확인 필요
2. **프로필 편집**: 기본값으로 설정된 이름을 사용자가 변경할 수 있도록 안내

---

## 부록: 관련 파일 목록

| 파일 | 역할 | 수정 필요 |
|------|------|-----------|
| `lib/screens/onboarding/onboarding_page.dart` | 스킵 로직 | 불필요 |
| `lib/screens/onboarding/steps/name_input_step.dart` | 이름 입력 UI | 불필요 |
| `lib/services/social_auth/providers/apple_auth_provider.dart` | Apple 인증 | 불필요 |
| `lib/services/social_auth/providers/google_auth_provider.dart` | Google 인증 | 불필요 |
| `lib/screens/auth/callback_page.dart` | 콜백 처리 | 불필요 |
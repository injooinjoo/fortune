# ğŸ› ï¸ Fortune ì•± ê°œë°œì ë ˆí¼ëŸ°ìŠ¤ ê°€ì´ë“œ

> **ìµœì¢… ì—…ë°ì´íŠ¸**: 2025ë…„ 7ì›” 15ì¼

## ğŸ“š ëª©ì°¨
1. [ì•„í‚¤í…ì²˜ ê°œìš”](#ì•„í‚¤í…ì²˜-ê°œìš”)
2. [ìš´ì„¸ íƒ€ì… ì¶”ê°€ ê°€ì´ë“œ](#ìš´ì„¸-íƒ€ì…-ì¶”ê°€-ê°€ì´ë“œ)
3. [API ì—”ë“œí¬ì¸íŠ¸ ê·œì¹™](#api-ì—”ë“œí¬ì¸íŠ¸-ê·œì¹™)
4. [í† í° ë¹„ìš© êµ¬ì¡°](#í† í°-ë¹„ìš©-êµ¬ì¡°)
5. [ìºì‹± ì „ëµ](#ìºì‹±-ì „ëµ)
6. [ì„±ëŠ¥ ìµœì í™”](#ì„±ëŠ¥-ìµœì í™”)
7. [ë³´ì•ˆ ê³ ë ¤ì‚¬í•­](#ë³´ì•ˆ-ê³ ë ¤ì‚¬í•­)
8. [ë°°í¬ í”„ë¡œì„¸ìŠ¤](#ë°°í¬-í”„ë¡œì„¸ìŠ¤)

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

### ì‹œìŠ¤í…œ êµ¬ì„±ë„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Flutter App                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   UI    â”‚  State   â”‚   Services      â”‚  â”‚
â”‚  â”‚ Screens â”‚ Riverpod â”‚ API/Storage     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Supabase Backend                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Database â”‚   Auth   â”‚ Edge Functions  â”‚  â”‚
â”‚  â”‚PostgreSQLâ”‚  OAuth  â”‚  TypeScript     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          External Services                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ OpenAI  â”‚ Weather  â”‚    Other        â”‚  â”‚
â”‚  â”‚   API   â”‚   API    â”‚   Services      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ê¸°ìˆ  ìŠ¤íƒ
```yaml
Frontend:
  - Framework: Flutter 3.16+
  - State Management: Riverpod 2.4+
  - UI: Material Design 3
  - Local Storage: SharedPreferences

Backend:
  - Platform: Supabase
  - Database: PostgreSQL 15
  - Serverless: Edge Functions (Deno)
  - Auth: Supabase Auth + OAuth

External:
  - AI: OpenAI GPT-4
  - Analytics: Google Analytics
```

---

## ğŸ¯ ìš´ì„¸ íƒ€ì… ì¶”ê°€ ê°€ì´ë“œ

### 1. ìš´ì„¸ íƒ€ì… ì •ì˜

**íŒŒì¼**: `/fortune_flutter/lib/core/constants/fortune_type_names.dart`

```dart
// 1. fortune_type_names.dartì— ì¶”ê°€
static const Map<String, String> names = {
  // ê¸°ì¡´ ìš´ì„¸ë“¤...
  'new-fortune': 'ìƒˆë¡œìš´ ìš´ì„¸',  // ì¶”ê°€
};

// 2. ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ë¡œì§ ì—…ë°ì´íŠ¸
static String getCategory(String fortuneType) {
  if (fortuneType == 'new-fortune') {
    return 'íŠ¹ë³„ ìš´ì„¸';
  }
  // ê¸°ì¡´ ë¡œì§...
}
```

### 2. API ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€

**íŒŒì¼**: `/supabase/functions/fortune-new/index.ts`

```typescript
import { serve } from 'https://deno.land/std@0.177.0/http/server.ts'
import { createClient } from '@supabase/supabase-js'
import { generateFortune } from '../_shared/openai.ts'
import { validateRequest } from '../_shared/validation.ts'
import { rateLimiter } from '../_shared/rate-limit.ts'

serve(async (req) => {
  try {
    // 1. ìš”ì²­ ê²€ì¦
    const { userId, params } = await validateRequest(req)
    
    // 2. Rate Limiting
    await rateLimiter.check(userId)
    
    // 3. íŒŒë¼ë¯¸í„° ê²€ì¦
    const { birthDate, specificParam } = params
    if (!birthDate || !specificParam) {
      throw new Error('Missing required parameters')
    }
    
    // 4. ìš´ì„¸ ìƒì„±
    const fortune = await generateFortune({
      type: 'new-fortune',
      birthDate,
      specificParam,
      prompt: `Generate a fortune for...`
    })
    
    // 5. ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL')!,
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
    )
    
    await supabase.from('fortunes').insert({
      user_id: userId,
      type: 'new-fortune',
      content: fortune,
      tokens_used: fortune.tokensUsed
    })
    
    // 6. ì‘ë‹µ
    return new Response(JSON.stringify({
      fortune,
      tokensUsed: fortune.tokensUsed
    }), {
      headers: { 'Content-Type': 'application/json' },
    })
    
  } catch (error) {
    return new Response(JSON.stringify({
      error: error.message
    }), {
      status: 400,
      headers: { 'Content-Type': 'application/json' },
    })
  }
})
```

### 3. Flutter ì„œë¹„ìŠ¤ ì¶”ê°€

**íŒŒì¼**: `/fortune_flutter/lib/services/fortune_service.dart`

```dart
class FortuneService {
  // ê¸°ì¡´ ë©”ì„œë“œë“¤...
  
  Future<FortuneResult> getNewFortune({
    required String userId,
    required DateTime birthDate,
    required String specificParam,
  }) async {
    try {
      // 1. ìºì‹œ í™•ì¸
      final cached = await _cache.get('new-fortune-$userId');
      if (cached != null && !_isExpired(cached)) {
        return FortuneResult.fromCache(cached);
      }
      
      // 2. API í˜¸ì¶œ
      final response = await _supabase.functions.invoke(
        'fortune-new',
        body: {
          'userId': userId,
          'birthDate': birthDate.toIso8601String(),
          'specificParam': specificParam,
        },
      );
      
      // 3. ì‘ë‹µ ì²˜ë¦¬
      if (response.status != 200) {
        throw FortuneException('Error: ${response.data}');
      }
      
      final result = FortuneResult.fromJson(response.data);
      
      // 4. ìºì‹œ ì €ì¥
      await _cache.set(
        'new-fortune-$userId',
        result.toJson(),
        duration: Duration(hours: 24),
      );
      
      // 5. í† í° ì°¨ê°
      await _tokenService.deduct(result.tokensUsed);
      
      return result;
      
    } catch (e) {
      throw FortuneException('ìš´ì„¸ ì¡°íšŒ ì‹¤íŒ¨: ${e.toString()}');
    }
  }
}
```

### 4. UI í˜ì´ì§€ ì¶”ê°€

**íŒŒì¼**: `/fortune_flutter/lib/features/fortune/presentation/pages/new_fortune_page.dart`

```dart
class NewFortunePage extends ConsumerStatefulWidget {
  const NewFortunePage({Key? key}) : super(key: key);

  @override
  ConsumerState<NewFortunePage> createState() => _NewFortunePageState();
}

class _NewFortunePageState extends ConsumerState<NewFortunePage> {
  final _formKey = GlobalKey<FormState>();
  DateTime? _birthDate;
  String _specificParam = '';
  
  @override
  Widget build(BuildContext context) {
    final fortuneAsync = ref.watch(newFortuneProvider);
    
    return Scaffold(
      appBar: AppBar(
        title: Text(FortuneTypeNames.getName('new-fortune')),
      ),
      body: Form(
        key: _formKey,
        child: ListView(
          padding: EdgeInsets.all(16),
          children: [
            // ìš´ì„¸ ì„¤ëª… ì¹´ë“œ
            FortuneExplanationCard(
              fortuneType: 'new-fortune',
            ),
            
            SizedBox(height: 16),
            
            // ì…ë ¥ í¼
            DatePickerField(
              label: 'ìƒë…„ì›”ì¼',
              onChanged: (date) => _birthDate = date,
            ),
            
            SizedBox(height: 16),
            
            TextFormField(
              decoration: InputDecoration(
                labelText: 'íŠ¹ë³„ íŒŒë¼ë¯¸í„°',
                hintText: 'ì…ë ¥í•´ì£¼ì„¸ìš”',
              ),
              onChanged: (value) => _specificParam = value,
              validator: (value) =>
                  value?.isEmpty ?? true ? 'í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤' : null,
            ),
            
            SizedBox(height: 24),
            
            // ìš´ì„¸ ë³´ê¸° ë²„íŠ¼
            ElevatedButton(
              onPressed: _getFortune,
              child: Text('ìš´ì„¸ ë³´ê¸° (30 í† í°)'),
            ),
            
            SizedBox(height: 24),
            
            // ê²°ê³¼ í‘œì‹œ
            fortuneAsync.when(
              loading: () => Center(child: CircularProgressIndicator()),
              error: (error, stack) => ErrorWidget(error.toString()),
              data: (fortune) => fortune != null
                  ? FortuneResultCard(fortune: fortune)
                  : SizedBox.shrink(),
            ),
          ],
        ),
      ),
    );
  }
  
  void _getFortune() {
    if (_formKey.currentState!.validate() && _birthDate != null) {
      ref.read(newFortuneProvider.notifier).getFortune(
        birthDate: _birthDate!,
        specificParam: _specificParam,
      );
    }
  }
}
```

---

## ğŸ”Œ API ì—”ë“œí¬ì¸íŠ¸ ê·œì¹™

### ëª…ëª… ê·œì¹™
```
/fortune-{type}
/fortune-{type}-{subtype}
/fortune-batch
/fortune-system
```

### ìš”ì²­/ì‘ë‹µ í˜•ì‹

#### ê¸°ë³¸ ìš”ì²­ êµ¬ì¡°
```json
{
  "userId": "string",
  "birthDate": "ISO 8601 date string",
  "birthTime": "HH:MM (optional)",
  "gender": "male|female (optional)",
  "isLunar": false,
  "additionalParams": {
    // ìš´ì„¸ë³„ ì¶”ê°€ íŒŒë¼ë¯¸í„°
  }
}
```

#### ê¸°ë³¸ ì‘ë‹µ êµ¬ì¡°
```json
{
  "success": true,
  "data": {
    "fortune": {
      "type": "string",
      "content": "string",
      "score": 0-100,
      "details": {},
      "luckyItems": {},
      "advice": []
    },
    "tokensUsed": 30,
    "generatedAt": "ISO 8601 timestamp",
    "expiresAt": "ISO 8601 timestamp"
  },
  "error": null
}
```

#### ì—ëŸ¬ ì‘ë‹µ
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "ERROR_CODE",
    "message": "Human readable error message",
    "details": {}
  }
}
```

### HTTP ìƒíƒœ ì½”ë“œ
- `200 OK`: ì„±ê³µ
- `400 Bad Request`: ì˜ëª»ëœ ìš”ì²­
- `401 Unauthorized`: ì¸ì¦ ì‹¤íŒ¨
- `403 Forbidden`: ê¶Œí•œ ì—†ìŒ (í† í° ë¶€ì¡± ë“±)
- `429 Too Many Requests`: Rate Limit ì´ˆê³¼
- `500 Internal Server Error`: ì„œë²„ ì˜¤ë¥˜

---

## ğŸ’° í† í° ë¹„ìš© êµ¬ì¡°

### ìš´ì„¸ë³„ í† í° ë¹„ìš©
```typescript
export const TOKEN_COSTS = {
  // ì‹œê°„ë³„ ìš´ì„¸
  'daily': 20,
  'today': 20,
  'tomorrow': 20,
  'hourly': 15,
  'weekly': 30,
  'monthly': 40,
  'yearly': 50,
  
  // ì „í†µ ìš´ì„¸
  'saju': 100,
  'traditional-saju': 80,
  'saju-psychology': 90,
  'tojeong': 60,
  'palmistry': 40,
  'physiognomy': 50,
  
  // ì„±ê²©/ìºë¦­í„°
  'mbti': 30,
  'personality': 35,
  'blood-type': 20,
  'zodiac': 25,
  'zodiac-animal': 25,
  
  // ì—°ì• /ì¸ì—°
  'love': 40,
  'marriage': 50,
  'compatibility': 60,
  'chemistry': 45,
  
  // ì§ì—…/ì‚¬ì—…
  'career': 40,
  'business': 50,
  'employment': 35,
  'startup': 45,
  
  // ì¬ë¬¼/íˆ¬ì
  'wealth': 40,
  'lucky-investment': 50,
  'lucky-stock': 45,
  'lucky-crypto': 45,
  'lucky-lottery': 30,
} as const;
```

### íŒ¨í‚¤ì§€ í• ì¸ìœ¨
```typescript
export const PACKAGE_DISCOUNTS = {
  'weekly': 0.30,    // 30% í• ì¸
  'monthly': 0.50,   // 50% í• ì¸
  'yearly': 0.70,    // 70% í• ì¸
  'batch-small': 0.20,  // 20% í• ì¸ (3-5ê°œ)
  'batch-medium': 0.35, // 35% í• ì¸ (6-10ê°œ)
  'batch-large': 0.50,  // 50% í• ì¸ (11ê°œ ì´ìƒ)
};
```

### í† í° ê³„ì‚° ë¡œì§
```typescript
function calculateTokenCost(
  fortuneTypes: string[],
  packageType?: string
): number {
  // ê¸°ë³¸ ë¹„ìš© ê³„ì‚°
  const baseCost = fortuneTypes.reduce(
    (sum, type) => sum + (TOKEN_COSTS[type] || 50),
    0
  );
  
  // íŒ¨í‚¤ì§€ í• ì¸ ì ìš©
  if (packageType && PACKAGE_DISCOUNTS[packageType]) {
    return Math.floor(baseCost * (1 - PACKAGE_DISCOUNTS[packageType]));
  }
  
  // ë°°ì¹˜ í• ì¸ ì ìš©
  const count = fortuneTypes.length;
  if (count >= 11) {
    return Math.floor(baseCost * (1 - PACKAGE_DISCOUNTS['batch-large']));
  } else if (count >= 6) {
    return Math.floor(baseCost * (1 - PACKAGE_DISCOUNTS['batch-medium']));
  } else if (count >= 3) {
    return Math.floor(baseCost * (1 - PACKAGE_DISCOUNTS['batch-small']));
  }
  
  return baseCost;
}
```

---

## ğŸš€ ìºì‹± ì „ëµ

### ìºì‹œ ë ˆë²¨
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Client Cache (Flutter)      â”‚
â”‚  - SharedPreferences            â”‚
â”‚  - 24ì‹œê°„ TTL                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CDN Cache (CloudFlare)     â”‚
â”‚  - ì •ì  ìì‚° ìºì‹±               â”‚
â”‚  - 1ì£¼ì¼ TTL                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Database Cache (PostgreSQL)   â”‚
â”‚  - ìš´ì„¸ ê²°ê³¼ ìºì‹±               â”‚
â”‚  - ìœ ì €ë³„ ìºì‹±                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Flutter ìºì‹± êµ¬í˜„
```dart
class FortuneCache {
  static const String _prefix = 'fortune_cache_';
  final SharedPreferences _prefs;
  
  // ìºì‹œ í‚¤ ìƒì„±
  String _getCacheKey(String fortuneType, String userId) {
    final date = DateTime.now().toIso8601String().split('T')[0];
    return '$_prefix${fortuneType}_${userId}_$date';
  }
  
  // ìºì‹œ ì €ì¥
  Future<void> set(String key, Map<String, dynamic> data) async {
    final cacheData = {
      'data': data,
      'timestamp': DateTime.now().millisecondsSinceEpoch,
      'ttl': Duration(hours: 24).inMilliseconds,
    };
    await _prefs.setString(key, jsonEncode(cacheData));
  }
  
  // ìºì‹œ ì¡°íšŒ
  Future<Map<String, dynamic>?> get(String key) async {
    final cached = _prefs.getString(key);
    if (cached == null) return null;
    
    final cacheData = jsonDecode(cached);
    final timestamp = cacheData['timestamp'] as int;
    final ttl = cacheData['ttl'] as int;
    
    // TTL ì²´í¬
    if (DateTime.now().millisecondsSinceEpoch - timestamp > ttl) {
      await _prefs.remove(key);
      return null;
    }
    
    return cacheData['data'] as Map<String, dynamic>;
  }
  
  // ìºì‹œ ë¬´íš¨í™”
  Future<void> invalidate(String pattern) async {
    final keys = _prefs.getKeys()
        .where((key) => key.startsWith(_prefix) && key.contains(pattern));
    for (final key in keys) {
      await _prefs.remove(key);
    }
  }
}
```

### Supabase ìºì‹± í…Œì´ë¸”
```sql
-- ìš´ì„¸ ìºì‹œ í…Œì´ë¸”
CREATE TABLE fortune_cache (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  fortune_type VARCHAR(50) NOT NULL,
  cache_key VARCHAR(255) UNIQUE NOT NULL,
  content JSONB NOT NULL,
  tokens_used INTEGER NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  
  INDEX idx_cache_key (cache_key),
  INDEX idx_expires_at (expires_at)
);

-- ë§Œë£Œëœ ìºì‹œ ìë™ ì‚­ì œ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION delete_expired_cache()
RETURNS void AS $$
BEGIN
  DELETE FROM fortune_cache
  WHERE expires_at < NOW();
END;
$$ LANGUAGE plpgsql;

-- ë§¤ì¼ ì‹¤í–‰ë˜ëŠ” í¬ë¡  ì‘ì—…
SELECT cron.schedule(
  'delete-expired-cache',
  '0 2 * * *',  -- ë§¤ì¼ ìƒˆë²½ 2ì‹œ
  'SELECT delete_expired_cache();'
);
```

---

## âš¡ ì„±ëŠ¥ ìµœì í™”

### 1. ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™”
```sql
-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_fortunes_user_type ON fortunes(user_id, type);
CREATE INDEX idx_fortunes_created_at ON fortunes(created_at DESC);
CREATE INDEX idx_user_tokens_user_id ON user_tokens(user_id);

-- íŒŒí‹°ì…”ë‹ (ì›”ë³„)
CREATE TABLE fortunes_2025_01 PARTITION OF fortunes
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 2. API ì‘ë‹µ ìµœì í™”
```typescript
// ë³‘ë ¬ ì²˜ë¦¬
async function getBatchFortunes(types: string[], userId: string) {
  const promises = types.map(type => 
    generateFortune({ type, userId })
  );
  
  // ë™ì‹œ ì‹¤í–‰
  const results = await Promise.allSettled(promises);
  
  return results.map((result, index) => ({
    type: types[index],
    success: result.status === 'fulfilled',
    data: result.status === 'fulfilled' ? result.value : null,
    error: result.status === 'rejected' ? result.reason : null,
  }));
}

// ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ
export async function streamFortune(req: Request) {
  const stream = new TransformStream();
  const writer = stream.writable.getWriter();
  
  // ì²­í¬ ë‹¨ìœ„ë¡œ ì „ì†¡
  for await (const chunk of generateFortuneStream(req)) {
    await writer.write(
      new TextEncoder().encode(JSON.stringify(chunk) + '\n')
    );
  }
  
  await writer.close();
  
  return new Response(stream.readable, {
    headers: {
      'Content-Type': 'application/x-ndjson',
      'Transfer-Encoding': 'chunked',
    },
  });
}
```

### 3. Flutter ìµœì í™”
```dart
// ì´ë¯¸ì§€ ë ˆì´ì§€ ë¡œë”©
class OptimizedFortuneImage extends StatelessWidget {
  final String imageUrl;
  
  @override
  Widget build(BuildContext context) {
    return CachedNetworkImage(
      imageUrl: imageUrl,
      placeholder: (context, url) => Shimmer.fromColors(
        baseColor: Colors.grey[300]!,
        highlightColor: Colors.grey[100]!,
        child: Container(
          width: double.infinity,
          height: 200,
          color: Colors.white,
        ),
      ),
      errorWidget: (context, url, error) => Icon(Icons.error),
      cacheManager: DefaultCacheManager(),
      maxHeightDiskCache: 400,
      memCacheHeight: 200,
    );
  }
}

// ë¦¬ìŠ¤íŠ¸ ê°€ìƒí™”
class FortuneListView extends StatelessWidget {
  final List<Fortune> fortunes;
  
  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      itemCount: fortunes.length,
      itemExtent: 120,  // ê³ ì • ë†’ì´ë¡œ ì„±ëŠ¥ í–¥ìƒ
      cacheExtent: 500,  // ìºì‹œ ë²”ìœ„ ì„¤ì •
      itemBuilder: (context, index) {
        return FortuneListItem(fortune: fortunes[index]);
      },
    );
  }
}
```

---

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. API ë³´ì•ˆ
```typescript
// Rate Limiting
export class RateLimiter {
  private attempts = new Map<string, number[]>();
  
  async check(userId: string, limit = 100, window = 3600000) {
    const now = Date.now();
    const userAttempts = this.attempts.get(userId) || [];
    
    // ì‹œê°„ ìœˆë„ìš° ë‚´ì˜ ìš”ì²­ë§Œ í•„í„°ë§
    const recentAttempts = userAttempts.filter(
      time => now - time < window
    );
    
    if (recentAttempts.length >= limit) {
      throw new Error('Rate limit exceeded');
    }
    
    recentAttempts.push(now);
    this.attempts.set(userId, recentAttempts);
  }
}

// ì…ë ¥ ê²€ì¦
export function validateFortuneRequest(params: any) {
  const schema = z.object({
    userId: z.string().uuid(),
    birthDate: z.string().datetime(),
    fortuneType: z.enum(FORTUNE_TYPES),
    additionalParams: z.record(z.any()).optional(),
  });
  
  return schema.parse(params);
}
```

### 2. ë°ì´í„° ë³´ì•ˆ
```sql
-- Row Level Security
ALTER TABLE fortunes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can only see their own fortunes"
ON fortunes FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Users can only insert their own fortunes"
ON fortunes FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- ë¯¼ê° ì •ë³´ ì•”í˜¸í™”
CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE user_sensitive_data (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  encrypted_data TEXT,  -- pgp_sym_encryptë¡œ ì•”í˜¸í™”
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 3. Flutter ë³´ì•ˆ
```dart
// ì•ˆì „í•œ ì €ì¥ì†Œ ì‚¬ìš©
class SecureStorage {
  static const _storage = FlutterSecureStorage();
  
  static Future<void> saveToken(String token) async {
    await _storage.write(key: 'auth_token', value: token);
  }
  
  static Future<String?> getToken() async {
    return await _storage.read(key: 'auth_token');
  }
  
  static Future<void> deleteToken() async {
    await _storage.delete(key: 'auth_token');
  }
}

// ì¸ì¦ì„œ ê³ ì • (Certificate Pinning)
class SecureHttpClient {
  static final client = HttpClient()
    ..badCertificateCallback = (cert, host, port) {
      final SHA256 sha256 = SHA256();
      final digest = sha256.convert(cert.der);
      return PINNED_CERTIFICATES.contains(digest.toString());
    };
}
```

---

## ğŸš€ ë°°í¬ í”„ë¡œì„¸ìŠ¤

### 1. í™˜ê²½ë³„ ì„¤ì •
```yaml
# development
development:
  supabase_url: https://dev.supabase.co
  openai_api_key: ${DEV_OPENAI_KEY}
  log_level: debug
  cache_ttl: 300  # 5ë¶„

# staging
staging:
  supabase_url: https://staging.supabase.co
  openai_api_key: ${STAGING_OPENAI_KEY}
  log_level: info
  cache_ttl: 3600  # 1ì‹œê°„

# production
production:
  supabase_url: https://prod.supabase.co
  openai_api_key: ${PROD_OPENAI_KEY}
  log_level: error
  cache_ttl: 86400  # 24ì‹œê°„
```

### 2. CI/CD íŒŒì´í”„ë¼ì¸
```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
      - run: flutter test
      
  deploy-functions:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: supabase/setup-cli@v1
      - run: supabase functions deploy
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          
  deploy-app:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
      - run: flutter build appbundle
      - uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT }}
          packageName: com.fortune.app
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
```

### 3. ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] API ë²„ì „ í˜¸í™˜ì„± í™•ì¸
- [ ] ìºì‹œ ë¬´íš¨í™” ì‹¤í–‰
- [ ] ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ í™•ì¸
- [ ] ë¡¤ë°± ê³„íš ì¤€ë¹„

---

## ğŸ“Š ëª¨ë‹ˆí„°ë§

### ì£¼ìš” ë©”íŠ¸ë¦­
```typescript
// ëª¨ë‹ˆí„°ë§í•  ë©”íŠ¸ë¦­
export const METRICS = {
  // API ë©”íŠ¸ë¦­
  'api.requests': 'counter',
  'api.latency': 'histogram',
  'api.errors': 'counter',
  
  // í† í° ë©”íŠ¸ë¦­
  'tokens.used': 'counter',
  'tokens.revenue': 'counter',
  
  // ìºì‹œ ë©”íŠ¸ë¦­
  'cache.hits': 'counter',
  'cache.misses': 'counter',
  'cache.evictions': 'counter',
  
  // ì‚¬ìš©ì ë©”íŠ¸ë¦­
  'users.active': 'gauge',
  'users.new': 'counter',
  'users.churn': 'counter',
};
```

### ì•Œë¦¼ ì„¤ì •
```yaml
alerts:
  - name: high_error_rate
    condition: rate(api.errors) > 0.05
    action: email, slack
    
  - name: low_cache_hit_rate
    condition: cache.hits / (cache.hits + cache.misses) < 0.7
    action: slack
    
  - name: high_latency
    condition: p95(api.latency) > 2000
    action: pagerduty
```

---

## ğŸ¤ ê¸°ì—¬ ê°€ì´ë“œ

### ì½”ë“œ ìŠ¤íƒ€ì¼
- Flutter: `flutter analyze` í†µê³¼ í•„ìˆ˜
- TypeScript: ESLint + Prettier ì„¤ì • ì¤€ìˆ˜
- SQL: ëŒ€ë¬¸ì í‚¤ì›Œë“œ, snake_case ì»¬ëŸ¼ëª…

### ì»¤ë°‹ ë©”ì‹œì§€
```
type(scope): subject

body

footer
```

ì˜ˆì‹œ:
```
feat(fortune): add new tarot fortune type

- Implement tarot card selection logic
- Add tarot interpretation AI prompts
- Create UI for card spread layouts

Closes #123
```

### PR í…œí”Œë¦¿
```markdown
## ë³€ê²½ ì‚¬í•­
- 

## í…ŒìŠ¤íŠ¸
- [ ] ìœ ë‹› í…ŒìŠ¤íŠ¸ ì¶”ê°€/ìˆ˜ì •
- [ ] í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
- [ ] ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì™„ë£Œ

## ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì½”ë“œ ë¦¬ë·° ìš”ì²­
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸
- [ ] CHANGELOG ì—…ë°ì´íŠ¸
```

---

*Happy Coding! ğŸš€*
import 'dart:math' as math;

/// 소원을 분석하여 신의 응답을 생성하는 서비스
class DivineWishAnalyzer {
  static const Map<String, List<String>> _categoryResponses = {
    '사랑': [
      '사랑은 기다리는 자에게 찾아옵니다. 당신의 진실한 마음이 상대방에게 전해질 것입니다. 서두르지 말고 자신을 더 사랑하며 기다리세요.',
      '운명의 상대는 이미 당신을 향해 걸어오고 있습니다. 자신감을 가지고 적극적으로 사랑을 표현하세요. 용기가 기적을 만들어낼 것입니다.',
      '사랑의 에너지가 당신 주변을 감싸고 있습니다. 과거의 상처를 놓아주고 새로운 사랑을 받아들일 준비를 하세요. 행복한 만남이 기다리고 있습니다.',
      '진정한 사랑은 서로를 성장시키는 것입니다. 상대방을 바꾸려 하지 말고 있는 그대로 사랑하세요. 그러면 더 깊은 사랑을 경험하게 될 것입니다.',
      '사랑은 주는 만큼 받게 됩니다. 먼저 베풀고 이해하려 노력하세요. 당신의 따뜻한 마음이 상대방의 마음을 움직일 것입니다.',
    ],
    '돈': [
      '재물은 노력하는 자에게 따라옵니다. 꾸준한 노력과 현명한 판단으로 점진적인 성장을 이루어나가세요. 큰 부는 하루아침에 이루어지지 않습니다.',
      '당신의 재능이 곧 재물로 이어질 것입니다. 자신만의 특별한 능력을 개발하고 그것을 세상에 나누세요. 진정한 가치는 돈으로 돌아올 것입니다.',
      '정직한 방법으로 얻은 재물만이 진정한 행복을 가져다줍니다. 욕심을 버리고 정도를 걸으세요. 하늘이 당신의 정직함을 보상할 것입니다.',
      '돈보다 중요한 것은 건강과 인간관계입니다. 균형 잡힌 삶을 살면서 재물을 추구하세요. 모든 것이 조화를 이룰 때 진정한 풍요가 찾아옵니다.',
      '새로운 기회가 당신을 기다리고 있습니다. 두려워하지 말고 도전하세요. 계산된 위험을 감수할 때 큰 수익을 얻을 수 있습니다.',
    ],
    '건강': [
      '몸과 마음의 건강은 모든 행복의 근본입니다. 규칙적인 생활과 긍정적인 마음가짐을 유지하세요. 당신의 몸은 스스로 치유하는 힘을 가지고 있습니다.',
      '스트레스가 모든 병의 근원입니다. 마음의 평화를 찾고 충분한 휴식을 취하세요. 자연과 함께하는 시간이 당신에게 큰 도움이 될 것입니다.',
      '건강한 식습관과 꾸준한 운동이 약보다 나은 치료법입니다. 당신의 몸이 원하는 것을 들어주고 사랑으로 돌보세요.',
      '가족과 사랑하는 사람들의 지지가 가장 큰 치유의 힘입니다. 혼자 견디려 하지 말고 도움을 요청하세요. 함께하면 모든 어려움을 극복할 수 있습니다.',
      '웃음과 기쁨이 최고의 명약입니다. 매일 감사한 일을 찾고 긍정적인 생각을 하세요. 밝은 마음이 건강한 몸을 만들어냅니다.',
    ],
    '성공': [
      '성공은 포기하지 않는 자에게 찾아옵니다. 실패를 두려워하지 말고 꾸준히 도전하세요. 모든 실패는 성공을 위한 소중한 경험이 됩니다.',
      '당신만의 독특한 길을 걸어가세요. 다른 사람과 비교하지 말고 자신만의 속도로 나아가면 됩니다. 진정한 성공은 자신과의 약속을 지키는 것입니다.',
      '성공의 열쇠는 준비와 기회의 만남입니다. 지금 하는 모든 노력이 미래의 성공을 위한 밑거름이 됩니다. 계속 준비하고 기회를 기다리세요.',
      '겸손함을 잃지 마세요. 성공할수록 더 많은 사람들에게 도움이 되는 사람이 되어야 합니다. 나누는 성공만이 진정한 의미를 가집니다.',
      '작은 성공들을 축하하고 인정하세요. 큰 성공은 작은 성공들이 쌓여 만들어집니다. 매일의 작은 진전을 소중히 여기며 나아가세요.',
    ],
    '가족': [
      '가족의 화목은 모든 복의 근원입니다. 서로를 이해하려 노력하고 소통을 게을리하지 마세요. 사랑은 표현해야 전해집니다.',
      '각자의 다름을 인정하고 존중하세요. 가족이라고 해서 모든 것이 같을 필요는 없습니다. 다양성 속에서 조화를 찾는 것이 진정한 가족의 모습입니다.',
      '어려운 시기일수록 가족이 뭉쳐야 합니다. 서로를 믿고 의지하세요. 함께 극복한 시련은 가족의 유대를 더욱 강하게 만들어줄 것입니다.',
      '감사의 마음을 자주 표현하세요. 당연한 것은 없습니다. 가족이 있다는 것 자체가 큰 축복임을 기억하고 매일 감사하며 살아가세요.',
      '다음 세대를 위한 좋은 본보기가 되세요. 당신의 행동과 말이 가족의 전통이 되고 후손들에게 전해질 것입니다.',
    ],
    '학업': [
      '지식은 누구도 빼앗을 수 없는 재산입니다. 꾸준히 공부하고 끊임없이 배우려는 자세를 유지하세요. 배움에는 끝이 없습니다.',
      '이해하려 노력하세요. 단순 암기보다는 원리를 파악하고 응용할 수 있는 능력을 기르는 것이 중요합니다. 깊이 있는 학습이 진정한 실력을 만듭니다.',
      '실패한 시험이나 낮은 점수에 좌절하지 마세요. 그것은 부족한 부분을 알려주는 신호입니다. 약점을 보완하면 더 큰 발전을 이룰 수 있습니다.',
      '혼자 공부하기 어려울 때는 도움을 요청하세요. 선생님, 친구, 가족의 도움을 받는 것은 부끄러운 일이 아닙니다. 함께 배우면 더 빨리 성장할 수 있습니다.',
      '공부의 목적을 명확히 하세요. 단순히 좋은 성적을 위한 공부가 아니라 자신의 꿈을 위한 공부라면 더 큰 동기를 얻을 수 있습니다.',
    ],
    '기타': [
      '당신의 소원은 특별합니다. 다른 사람들이 이해하지 못해도 괜찮습니다. 자신의 마음을 믿고 끝까지 추구하세요.',
      '모든 소원에는 그 나름의 의미가 있습니다. 작다고 생각되는 소원도 당신에게는 중요한 것입니다. 소중히 여기고 이루기 위해 노력하세요.',
      '때로는 다른 길로 인도되기도 합니다. 원래 계획과 다르게 흘러가더라도 그것이 더 좋은 결과를 가져다줄 수 있습니다. 열린 마음을 가지세요.',
      '인내심을 가지세요. 좋은 일은 적절한 때에 찾아옵니다. 조급해하지 말고 꾸준히 노력하며 기다리면 반드시 좋은 결과가 있을 것입니다.',
      '주변 사람들에게 감사의 마음을 표현하세요. 당신의 소원이 이루어지는 과정에서 많은 사람들의 도움이 있을 것입니다.',
    ],
  };

  /// 소원을 분석하여 신의 응답을 생성합니다
  static String generateDivineResponse({
    required String wishText,
    required String category,
    required int urgency,
  }) {
    final responses = _categoryResponses[category] ?? _categoryResponses['기타']!;
    
    // 소원 텍스트와 긴급도를 바탕으로 응답 선택
    final responseIndex = _calculateResponseIndex(wishText, urgency, responses.length);
    final String baseResponse = responses[responseIndex];
    
    // 긴급도에 따른 추가 메시지
    final urgencyMessage = _getUrgencyMessage(urgency);
    
    // 개인화된 메시지 추가
    final personalizedMessage = _getPersonalizedMessage(wishText, category);
    
    return '$baseResponse\n\n$urgencyMessage\n\n$personalizedMessage';
  }

  /// 응답 인덱스를 계산합니다
  static int _calculateResponseIndex(String wishText, int urgency, int responseCount) {
    // 소원 텍스트의 해시와 긴급도를 조합하여 인덱스 계산
    final textHash = wishText.hashCode.abs();
    final seed = textHash + urgency * 1000;
    final random = math.Random(seed);
    return random.nextInt(responseCount);
  }

  /// 긴급도에 따른 메시지를 반환합니다
  static String _getUrgencyMessage(int urgency) {
    switch (urgency) {
      case 1:
        return '천천히 기다리세요. 모든 것에는 때가 있습니다. 조급해하지 마시고 자연스러운 흐름을 따라가세요.';
      case 2:
        return '꾸준한 노력이 필요합니다. 작은 단계부터 시작하여 점진적으로 목표에 다가가세요.';
      case 3:
        return '당신의 간절함이 하늘에 닿았습니다. 계속 노력하되 마음의 평정을 잃지 마세요.';
      case 4:
        return '강한 의지가 느껴집니다. 이 에너지를 긍정적인 방향으로 활용하면 큰 변화를 만들어낼 수 있습니다.';
      case 5:
        return '당신의 온 마음을 다한 소원을 신이 들었습니다. 믿음을 잃지 마세요. 기적은 믿는 자에게 찾아옵니다.';
      default:
        return '당신의 소원에는 특별한 힘이 담겨 있습니다.';
    }
  }

  /// 개인화된 메시지를 생성합니다
  static String _getPersonalizedMessage(String wishText, String category) {
    // 소원 텍스트에서 키워드 추출하여 개인화된 메시지 생성
    final keywords = _extractKeywords(wishText);
    
    if (keywords.contains('빨리') || keywords.contains('급') || keywords.contains('어서')) {
      return '서두르는 마음을 이해하지만, 좋은 일은 적절한 때에 찾아옵니다. 인내심을 가지고 기다리세요.';
    }
    
    if (keywords.contains('꼭') || keywords.contains('반드시') || keywords.contains('제발')) {
      return '당신의 절실함이 전해집니다. 이런 진실한 마음이 있다면 반드시 길이 열릴 것입니다.';
    }
    
    if (keywords.contains('행복') || keywords.contains('기쁨') || keywords.contains('웃음')) {
      return '행복을 추구하는 마음이 아름답습니다. 작은 기쁨부터 소중히 여기며 더 큰 행복을 만들어가세요.';
    }
    
    if (keywords.contains('건강') || keywords.contains('아프') || keywords.contains('병')) {
      return '건강은 모든 것의 기초입니다. 몸과 마음을 모두 돌보시며 긍정적인 에너지를 유지하세요.';
    }
    
    // 카테고리별 기본 개인화 메시지
    switch (category) {
      case '사랑':
        return '사랑하는 마음 자체가 이미 아름다운 기적입니다. 그 마음을 소중히 여기세요.';
      case '돈':
        return '진정한 풍요는 마음의 풍요에서 시작됩니다. 감사하는 마음을 가지세요.';
      case '성공':
        return '성공을 향한 여정 자체가 이미 성공입니다. 과정을 즐기며 나아가세요.';
      default:
        return '당신의 소원이 이루어질 그날까지 희망을 잃지 마세요. 신은 항상 당신과 함께합니다.';
    }
  }

  /// 소원 텍스트에서 키워드를 추출합니다
  static List<String> _extractKeywords(String text) {
    final keywords = <String>[];
    final keywordList = [
      '빨리', '급', '어서', '꼭', '반드시', '제발', '행복', '기쁨', '웃음',
      '건강', '아프', '병', '사랑', '결혼', '연애', '돈', '부자', '성공',
      '취업', '합격', '가족', '부모', '자식', '친구', '공부', '시험'
    ];
    
    for (final keyword in keywordList) {
      if (text.contains(keyword)) {
        keywords.add(keyword);
      }
    }
    
    return keywords;
  }

  /// 행운의 조언을 생성합니다
  static String generateLuckyAdvice({
    required String category,
    required int urgency,
  }) {
    final adviceMap = {
      '사랑': [
        '오늘 분홍색 옷을 입으면 사랑운이 상승합니다.',
        '꽃을 보거나 향기를 맡으면 좋은 인연이 찾아올 것입니다.',
        '하트 모양의 물건을 가까이 두세요.',
      ],
      '돈': [
        '지갑을 정리하고 영수증을 버리세요.',
        '동전을 모아서 저금통에 넣으면 재물운이 상승합니다.',
        '황금색이나 초록색 물건을 가까이 두세요.',
      ],
      '건강': [
        '충분한 수면과 규칙적인 식사를 하세요.',
        '자연에서 깊게 숨을 쉬는 시간을 가지세요.',
        '초록색 음식을 많이 드세요.',
      ],
      '성공': [
        '일찍 일어나서 계획을 세우는 시간을 가지세요.',
        '파란색 펜으로 목표를 적어보세요.',
        '성공한 사람들의 이야기를 읽어보세요.',
      ],
      '가족': [
        '가족 사진을 보며 감사의 마음을 가져보세요.',
        '따뜻한 차를 함께 마시는 시간을 만드세요.',
        '가족에게 안부 인사를 전해보세요.',
      ],
      '학업': [
        '새 노트나 펜을 준비해서 기분을 전환하세요.',
        '공부 공간을 깔끔하게 정리하세요.',
        '파란색이나 보라색 물건을 책상에 두세요.',
      ],
    };
    
    final advice = adviceMap[category] ?? [
      '긍정적인 마음가짐을 유지하세요.',
      '감사하는 마음을 가지세요.',
      '꾸준한 노력을 계속하세요.',
    ];
    
    final random = math.Random(urgency * 100);
    return advice[random.nextInt(advice.length)];
  }
}